<script>Config={resources:{levels:{pathFormat:"resources/lvl/{0}/{1}",meta:{locked:[[0,0,0,0,0,0],[0,1,1,1,1,1],[0,1,1,1,1,1]]}},images:{path:"resources/img",files:{splash:{png:{text:["dot","loading"]}},common:{png:{digit:{pos:[0,1,2,3,4,5,6,7,8,9],neg:[0,1,2,3,4,5,6,7,8,9],big:[0,1,2,3,4,5,6,7,8,9],_:["separator"]},text:{levelName:{1:[1,2,3,4,5,6],2:[1],3:[1]},intro:"title goodLuck quickHints aCircleHint1 aCircleHint2 circleHint1 circleHint2 circleHint3 circleHint4 pCircleHint1 pCircleHint2 pCircleHint3 scoreHint1 scoreHint2".split(" "),_:"continuing difficulty level score quit limit skipped highScore worseScore sameScore completed".split(" ")},icon:["empty","plus","minus","equal","locked"],circle:{active:[1,2,3,4,5],passive:[1,2,3,4,5],connection:["marker"]},menu:{side:["left","right"]},button:{progress:{small:["base","hand","complete","empty"],large:["base","hand","complete","empty"]},difficulty:["easy","normal","hard","choose"],music:["on","off"],sound:["on","off"],quit:["yes","no"],_:["pause","restart","resume","next"]},bg:["trans"]},jpg:{bg:["normal","gs"]}}}},audio:{path:"resources/aud",files:{sound:{tap:["circle","button"],_:["tick"]},music:[1,2,3,4,5]}}}};var Kinetic={};!function(){Kinetic.version="4.5.4";Kinetic.Filters={};Kinetic.Node=function(b){this._nodeInit(b)};Kinetic.Shape=function(b){this._initShape(b)};Kinetic.Container=function(b){this._containerInit(b)};Kinetic.Stage=function(b){this._initStage(b)};Kinetic.Layer=function(b){this._initLayer(b)};Kinetic.Group=function(b){this._initGroup(b)};Kinetic.Global={stages:[],idCounter:0,ids:{},names:{},shapes:{},isDragging:function(){var b=Kinetic.DD;return b?b.isDragging:!1},isDragReady:function(){var b=Kinetic.DD;return b?!!b.node:!1},_addId:function(b,a){void 0!==a&&(this.ids[a]=b)},_removeId:function(b){void 0!==b&&delete this.ids[b]},_addName:function(b,a){void 0!==a&&(void 0===this.names[a]&&(this.names[a]=[]),this.names[a].push(b))},_removeName:function(b,a){if(void 0!==b){var c=this.names[b];if(void 0!==c){for(var d=0;d<c.length;d++)c[d]._id===a&&c.splice(d,1);0===c.length&&delete this.names[b]}}}}}();(function(b,a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(a):b.returnExports=a()})(this,function(){return Kinetic});!function(){Kinetic.Collection=function(){var b=[].slice.call(arguments),a=b.length,c=0;for(this.length=a;a>c;c++)this[c]=b[c];return this};Kinetic.Collection.prototype=[];Kinetic.Collection.prototype.each=function(b){for(var a=0;a<this.length;a++)b(this[a],a)};Kinetic.Collection.prototype.toArray=function(){for(var b=[],a=0;a<this.length;a++)b.push(this[a]);return b};Kinetic.Collection.mapMethods=function(b){var a,c=b.length;for(a=0;c>a;a++)!function(a){var c=b[a];Kinetic.Collection.prototype[c]=function(){var a,d=this.length;args=[].slice.call(arguments);for(a=0;d>a;a++)this[a][c].apply(this[a],args)}}(a)}}();(function(){Kinetic.Transform=function(){this.m=[1,0,0,1,0,0]};Kinetic.Transform.prototype={translate:function(b,a){this.m[4]+=this.m[0]*b+this.m[2]*a;this.m[5]+=this.m[1]*b+this.m[3]*a},scale:function(b,a){this.m[0]*=b;this.m[1]*=b;this.m[2]*=a;this.m[3]*=a},rotate:function(b){var a=Math.cos(b);b=Math.sin(b);var c=this.m[1]*a+this.m[3]*b,d=this.m[0]*-b+this.m[2]*a,f=this.m[1]*-b+this.m[3]*a;this.m[0]=this.m[0]*a+this.m[2]*b;this.m[1]=c;this.m[2]=d;this.m[3]=f},getTranslation:function(){return{x:this.m[4],y:this.m[5]}},skew:function(b,a){var c=this.m[1]+this.m[3]*a,d=this.m[2]+this.m[0]*b,f=this.m[3]+this.m[1]*b;this.m[0]+=this.m[2]*a;this.m[1]=c;this.m[2]=d;this.m[3]=f},multiply:function(b){var a=this.m[1]*b.m[0]+this.m[3]*b.m[1],c=this.m[0]*b.m[2]+this.m[2]*b.m[3],d=this.m[1]*b.m[2]+this.m[3]*b.m[3],f=this.m[0]*b.m[4]+this.m[2]*b.m[5]+this.m[4],e=this.m[1]*b.m[4]+this.m[3]*b.m[5]+this.m[5];this.m[0]=this.m[0]*b.m[0]+this.m[2]*b.m[1];this.m[1]=a;this.m[2]=c;this.m[3]=d;this.m[4]=f;this.m[5]=e},invert:function(){var b=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),a=-this.m[1]*b,c=-this.m[2]*b,d=this.m[0]*b,f=b*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),e=b*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=this.m[3]*b;this.m[1]=a;this.m[2]=c;this.m[3]=d;this.m[4]=f;this.m[5]=e},getMatrix:function(){return this.m}}})();(function(){var b=Math.PI/180,a=180/Math.PI,c={aqua:[0,255,255],lime:[0,255,0],silver:[192,192,192],black:[0,0,0],maroon:[128,0,0],teal:[0,128,128],blue:[0,0,255],navy:[0,0,128],white:[255,255,255],fuchsia:[255,0,255],olive:[128,128,0],yellow:[255,255,0],orange:[255,165,0],gray:[128,128,128],purple:[128,0,128],green:[0,128,0],red:[255,0,0],pink:[255,192,203],cyan:[0,255,255],transparent:[255,255,255,0]},d=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;Kinetic.Util={_isElement:function(a){return!(!a||1!=a.nodeType)},_isFunction:function(a){return!!(a&&a.constructor&&a.call&&a.apply)},_isObject:function(a){return!!a&&a.constructor==Object},_isArray:function(a){return"[object Array]"==Object.prototype.toString.call(a)},_isNumber:function(a){return"[object Number]"==Object.prototype.toString.call(a)},_isString:function(a){return"[object String]"==Object.prototype.toString.call(a)},_hasMethods:function(a){var c,d=[];for(c in a)this._isFunction(a[c])&&d.push(c);return 0<d.length},_isInDocument:function(a){for(;a=a.parentNode;)if(a==document)return!0;return!1},_getXY:function(a){if(this._isNumber(a))return{x:a,y:a};if(this._isArray(a))if(1===a.length){a=a[0];if(this._isNumber(a))return{x:a,y:a};if(this._isArray(a))return{x:a[0],y:a[1]};if(this._isObject(a))return a}else{if(2<=a.length)return{x:a[0],y:a[1]}}else if(this._isObject(a))return a;return null},_getSize:function(a){if(this._isNumber(a))return{width:a,height:a};if(this._isArray(a))if(1===a.length){a=a[0];if(this._isNumber(a))return{width:a,height:a};if(this._isArray(a)){if(4<=a.length)return{width:a[2],height:a[3]};if(2<=a.length)return{width:a[0],height:a[1]}}else if(this._isObject(a))return a}else{if(4<=a.length)return{width:a[2],height:a[3]};if(2<=a.length)return{width:a[0],height:a[1]}}else if(this._isObject(a))return a;return null},_getPoints:function(a){var c,d,b=[];if(void 0===a)return[];if(d=a.length,this._isArray(a[0])){for(c=0;d>c;c++)b.push({x:a[c][0],y:a[c][1]});return b}if(this._isObject(a[0]))return a;for(c=0;d>c;c+=2)b.push({x:a[c],y:a[c+1]});return b},_getImage:function(a,c){var d,b,k,l;a?this._isElement(a)?c(a):this._isString(a)?(d=new Image,d.onload=function(){c(d)},d.src=a):a.data?(b=document.createElement("canvas"),b.width=a.width,b.height=a.height,k=b.getContext("2d"),k.putImageData(a,0,0),l=b.toDataURL(),d=new Image,d.onload=function(){c(d)},d.src=l):c(null):c(null)},_rgbToHex:function(a,c,d){return(16777216+(a<<16)+(c<<8)+d).toString(16).slice(1)},_hexToRgb:function(a){a=a.replace("#","");a=parseInt(a,16);return{r:255&a>>16,g:255&a>>8,b:255&a}},getRandomColor:function(){for(var a=(16777215*Math.random()<<0).toString(16);6>a.length;)a="0"+a;return"#"+a},getRGB:function(a){var b;return a in c?(b=c[a],{r:b[0],g:b[1],b:b[2]}):"#"===a[0]?this._hexToRgb(a.substring(1)):"rgb("===a.substr(0,4)?(b=d.exec(a.replace(/ /g,"")),{r:parseInt(b[1],10),g:parseInt(b[2],10),b:parseInt(b[3],10)}):{r:0,g:0,b:0}},_merge:function(a,c){var d=this._clone(c),b;for(b in a)d[b]=this._isObject(a[b])?this._merge(a[b],d[b]):a[b];return d},_clone:function(a){var c={},d;for(d in a)c[d]=this._isObject(a[d])?this._clone(a[d]):a[d];return c},_degToRad:function(a){return a*b},_radToDeg:function(c){return c*a},_capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},warn:function(a){window.console&&console.warn&&console.warn("Kinetic warning: "+a)},extend:function(a,c){for(var d in c.prototype)d in a.prototype||(a.prototype[d]=c.prototype[d])},addMethods:function(a,c){for(var d in c)a.prototype[d]=c[d]},_getControlPoints:function(a,c,d,b){var k=a.x;a=a.y;var l=c.x;c=c.y;var m=d.x;d=d.y;var n=Math.sqrt(Math.pow(l-k,2)+Math.pow(c-a,2)),p=Math.sqrt(Math.pow(m-l,2)+Math.pow(d-c,2)),r=b*n/(n+p);b=b*p/(n+p);return[{x:l-r*(m-k),y:c-r*(d-a)},{x:l+b*(m-k),y:c+b*(d-a)}]},_expandPoints:function(a,c){var d,b,k=a.length,l=[];for(d=1;k-1>d;d++)b=Kinetic.Util._getControlPoints(a[d-1],a[d],a[d+1],c),l.push(b[0]),l.push(a[d]),l.push(b[1]);return l}}})();!function(){var b=document.createElement("canvas").getContext("2d"),a=(window.devicePixelRatio||1)/(b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1);Kinetic.Canvas=function(a){this.init(a)};Kinetic.Canvas.prototype={init:function(c){c=c||{};var d=c.width||0,b=c.height||0,e=c.contextType||"2d";this.pixelRatio=c.pixelRatio||a;this.element=document.createElement("canvas");this.element.style.padding=0;this.element.style.margin=0;this.element.style.border=0;this.element.style.background="transparent";this.context=this.element.getContext(e);this.setSize(d,b)},getElement:function(){return this.element},getContext:function(){return this.context},setWidth:function(a){this.width=this.element.width=a*this.pixelRatio;this.element.style.width=a+"px"},setHeight:function(a){this.height=this.element.height=a*this.pixelRatio;this.element.style.height=a+"px"},getWidth:function(){return this.width},getHeight:function(){return this.height},setSize:function(a,d){this.setWidth(a);this.setHeight(d)},clear:function(){var a=this.getContext();this.getElement();a.clearRect(0,0,this.getWidth(),this.getHeight())},toDataURL:function(a,d){try{return this.element.toDataURL(a,d)}catch(b){try{return this.element.toDataURL()}catch(e){return Kinetic.Util.warn("Unable to get data URL. "+e.message),""}}},fill:function(a){a.getFillEnabled()&&this._fill(a)},stroke:function(a){a.getStrokeEnabled()&&this._stroke(a)},fillStroke:function(a){var d=a.getFillEnabled();d&&this._fill(a);a.getStrokeEnabled()&&this._stroke(a,a.hasShadow()&&a.hasFill()&&d)},applyShadow:function(a,d){var b=this.context;b.save();this._applyShadow(a);d();b.restore();d()},_applyLineCap:function(a){(a=a.getLineCap())&&(this.context.lineCap=a)},_applyOpacity:function(a){a=a.getAbsoluteOpacity();1!==a&&(this.context.globalAlpha=a)},_applyLineJoin:function(a){(a=a.getLineJoin())&&(this.context.lineJoin=a)},_applyAncestorTransforms:function(a){var d,b,e=this.context;a._eachAncestorReverse(function(a){d=a.getTransform(!0);b=d.getMatrix();e.transform(b[0],b[1],b[2],b[3],b[4],b[5])},!0)},_clip:function(a){var d=this.getContext();d.save();this._applyAncestorTransforms(a);d.beginPath();a.getClipFunc()(this);d.clip();d.setTransform(1,0,0,1,0,0)}};Kinetic.SceneCanvas=function(a){Kinetic.Canvas.call(this,a)};Kinetic.SceneCanvas.prototype={setWidth:function(a){var d=this.pixelRatio;Kinetic.Canvas.prototype.setWidth.call(this,a);this.context.scale(d,d)},setHeight:function(a){var d=this.pixelRatio;Kinetic.Canvas.prototype.setHeight.call(this,a);this.context.scale(d,d)},_fillColor:function(a){var d=this.context,b=a.getFill();d.fillStyle=b;a._fillFunc(d)},_fillPattern:function(a){var d=this.context,b=a.getFillPatternImage(),e=a.getFillPatternX(),g=a.getFillPatternY(),h=a.getFillPatternScale(),k=a.getFillPatternRotation(),l=a.getFillPatternOffset();a=a.getFillPatternRepeat();(e||g)&&d.translate(e||0,g||0);k&&d.rotate(k);h&&d.scale(h.x,h.y);l&&d.translate(-1*l.x,-1*l.y);d.fillStyle=d.createPattern(b,a||"repeat");d.fill()},_fillLinearGradient:function(a){var d=this.context,b=a.getFillLinearGradientStartPoint(),e=a.getFillLinearGradientEndPoint();a=a.getFillLinearGradientColorStops();b=d.createLinearGradient(b.x,b.y,e.x,e.y);if(a){for(e=0;e<a.length;e+=2)b.addColorStop(a[e],a[e+1]);d.fillStyle=b;d.fill()}},_fillRadialGradient:function(a){var d=this.context,b=a.getFillRadialGradientStartPoint(),e=a.getFillRadialGradientEndPoint(),g=a.getFillRadialGradientStartRadius(),h=a.getFillRadialGradientEndRadius();a=a.getFillRadialGradientColorStops();b=d.createRadialGradient(b.x,b.y,g,e.x,e.y,h);for(e=0;e<a.length;e+=2)b.addColorStop(a[e],a[e+1]);d.fillStyle=b;d.fill()},_fill:function(a,d){var b=this.context,e=a.getFill(),g=a.getFillPatternImage(),h=a.getFillLinearGradientColorStops(),k=a.getFillRadialGradientColorStops(),l=a.getFillPriority();b.save();!d&&a.hasShadow()&&this._applyShadow(a);e&&"color"===l?this._fillColor(a):g&&"pattern"===l?this._fillPattern(a):h&&"linear-gradient"===l?this._fillLinearGradient(a):k&&"radial-gradient"===l?this._fillRadialGradient(a):e?this._fillColor(a):g?this._fillPattern(a):h?this._fillLinearGradient(a):k&&this._fillRadialGradient(a);b.restore();!d&&a.hasShadow()&&this._fill(a,!0)},_stroke:function(a,d){var b=this.context,e=a.getStroke(),g=a.getStrokeWidth(),h=a.getDashArray();(e||g)&&(b.save(),a.getStrokeScaleEnabled()||b.setTransform(1,0,0,1,0,0),this._applyLineCap(a),h&&a.getDashArrayEnabled()&&(b.setLineDash?b.setLineDash(h):"mozDash"in b?b.mozDash=h:"webkitLineDash"in b&&(b.webkitLineDash=h)),!d&&a.hasShadow()&&this._applyShadow(a),b.lineWidth=g||2,b.strokeStyle=e||"black",a._strokeFunc(b),b.restore(),!d&&a.hasShadow()&&this._stroke(a,!0))},_applyShadow:function(a){var d=this.context;if(a.hasShadow()&&a.getShadowEnabled()){var b=a.getAbsoluteOpacity(),e=a.getShadowColor()||"black",g=a.getShadowBlur()||5,h=a.getShadowOffset()||{x:0,y:0};a.getShadowOpacity()&&(d.globalAlpha=a.getShadowOpacity()*b);d.shadowColor=e;d.shadowBlur=g;d.shadowOffsetX=h.x;d.shadowOffsetY=h.y}}};Kinetic.Util.extend(Kinetic.SceneCanvas,Kinetic.Canvas);Kinetic.HitCanvas=function(a){Kinetic.Canvas.call(this,a)};Kinetic.HitCanvas.prototype={_fill:function(a){var d=this.context;d.save();d.fillStyle=a.colorKey;a._fillFuncHit(d);d.restore()},_stroke:function(a){var d=this.context,b=a.getStroke(),e=a.getStrokeWidth();(b||e)&&(this._applyLineCap(a),d.save(),d.lineWidth=e||2,d.strokeStyle=a.colorKey,a._strokeFuncHit(d),d.restore())}};Kinetic.Util.extend(Kinetic.HitCanvas,Kinetic.Canvas)}();!function(){var b="Shape";Kinetic.Util.addMethods(Kinetic.Node,{_nodeInit:function(a){this._id=Kinetic.Global.idCounter++;this.eventListeners={};this.setAttrs(a)},on:function(a,c){var d,b,e,g=a.split(" "),h=g.length;for(d=0;h>d;d++)b=g[d],e=b.split("."),b=e[0],e=1<e.length?e[1]:"",this.eventListeners[b]||(this.eventListeners[b]=[]),this.eventListeners[b].push({name:e,handler:c});return this},off:function(a){var c,d,b,e,g,h=a.split(" "),k=h.length;for(a=0;k>a;a++)if(c=h[a],b=c,e=b.split("."),g=e[0],1<e.length)if(g)this.eventListeners[g]&&this._off(g,e[1]);else for(d in this.eventListeners)this._off(d,e[1]);else delete this.eventListeners[g];return this},remove:function(){var a=this.getParent();return a&&a.children&&(a.children.splice(this.index,1),a._setChildrenIndices(),delete this.parent),this},destroy:function(){var a=Kinetic.Global;a._removeId(this.getId());a._removeName(this.getName(),this._id);this.remove()},getAttr:function(a){var c="get"+Kinetic.Util._capitalize(a);return Kinetic.Util._isFunction(this[c])?this[c]():this.attrs[a]},setAttr:function(){var a=Array.prototype.slice.call(arguments),c=a[0],d=this["set"+Kinetic.Util._capitalize(c)];return a.shift(),Kinetic.Util._isFunction(d)?d.apply(this,a):this.attrs[c]=a[0],this},getAttrs:function(){return this.attrs||{}},createAttrs:function(){return void 0===this.attrs&&(this.attrs={}),this},setAttrs:function(a){var c,d;if(a)for(c in a)"children"===c||(d="set"+Kinetic.Util._capitalize(c),Kinetic.Util._isFunction(this[d])?this[d](a[c]):this._setAttr(c,a[c]));return this},getVisible:function(){var a=this.attrs.visible,c=this.getParent();return void 0===a&&(a=!0),a&&c&&!c.getVisible()?!1:a},getListening:function(){var a=this.attrs.listening,c=this.getParent();return void 0===a&&(a=!0),a&&c&&!c.getListening()?!1:a},show:function(){return this.setVisible(!0),this},hide:function(){return this.setVisible(!1),this},getZIndex:function(){return this.index||0},getAbsoluteZIndex:function(){function a(l){c=[];d=l.length;for(f=0;d>f;f++)e=l[f],k++,e.nodeType!==b&&(c=c.concat(e.getChildren().toArray())),e._id===h._id&&(f=d);0<c.length&&c[0].getLevel()<=g&&a(c)}var c,d,f,e,g=this.getLevel(),h=(this.getStage(),this),k=0;return"Stage"!==h.nodeType&&a(h.getStage().getChildren()),k},getLevel:function(){for(var a=0,c=this.parent;c;)a++,c=c.parent;return a},setPosition:function(){var a=Kinetic.Util._getXY([].slice.call(arguments));return this.setX(a.x),this.setY(a.y),this},getPosition:function(){return{x:this.getX(),y:this.getY()}},getAbsolutePosition:function(){var a=this.getAbsoluteTransform(),c=this.getOffset();return a.translate(c.x,c.y),a.getTranslation()},setAbsolutePosition:function(){var a,c=Kinetic.Util._getXY([].slice.call(arguments)),d=this._clearTransform();return this.attrs.x=d.x,this.attrs.y=d.y,delete d.x,delete d.y,a=this.getAbsoluteTransform(),a.invert(),a.translate(c.x,c.y),c={x:this.attrs.x+a.getTranslation().x,y:this.attrs.y+a.getTranslation().y},this.setPosition(c.x,c.y),this._setTransform(d),this},move:function(){var a=Kinetic.Util._getXY([].slice.call(arguments)),c=this.getX(),d=this.getY();return void 0!==a.x&&(c+=a.x),void 0!==a.y&&(d+=a.y),this.setPosition(c,d),this},_eachAncestorReverse:function(a,c){var d,b,e=[];d=this.getParent();for(c&&e.unshift(this);d;)e.unshift(d),d=d.parent;d=e.length;for(b=0;d>b;b++)a(e[b])},rotate:function(a){return this.setRotation(this.getRotation()+a),this},rotateDeg:function(a){return this.setRotation(this.getRotation()+Kinetic.Util._degToRad(a)),this},moveToTop:function(){return this.parent.children.splice(this.index,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0},moveUp:function(){var a=this.index;return this.parent.getChildren().length-1>a?(this.parent.children.splice(a,1),this.parent.children.splice(a+1,0,this),this.parent._setChildrenIndices(),!0):!1},moveDown:function(){var a=this.index;return 0<a?(this.parent.children.splice(a,1),this.parent.children.splice(a-1,0,this),this.parent._setChildrenIndices(),!0):!1},moveToBottom:function(){var a=this.index;return 0<a?(this.parent.children.splice(a,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0):!1},setZIndex:function(a){return this.parent.children.splice(this.index,1),this.parent.children.splice(a,0,this),this.parent._setChildrenIndices(),this},getAbsoluteOpacity:function(){var a=this.getOpacity();return this.getParent()&&(a*=this.getParent().getAbsoluteOpacity()),a},moveTo:function(a){return Kinetic.Node.prototype.remove.call(this),a.add(this),this},toObject:function(){var a,c,d=Kinetic.Util,b={},e=this.getAttrs();b.attrs={};for(a in e)c=e[a],d._isFunction(c)||d._isElement(c)||d._isObject(c)&&d._hasMethods(c)||(b.attrs[a]=c);return b.className=this.getClassName(),b},toJSON:function(){return JSON.stringify(this.toObject())},getParent:function(){return this.parent},getLayer:function(){return this.getParent().getLayer()},getStage:function(){return this.getParent()?this.getParent().getStage():void 0},fire:function(a,c,d){return d?this._fireAndBubble(a,c||{}):this._fire(a,c||{}),this},getAbsoluteTransform:function(){var a,c=new Kinetic.Transform;return this._eachAncestorReverse(function(d){a=d.getTransform();c.multiply(a)},!0),c},_getAndCacheTransform:function(){var a=new Kinetic.Transform,c=this.getX(),d=this.getY(),b=this.getRotation(),e=this.getScaleX(),g=this.getScaleY(),h=this.getSkewX(),k=this.getSkewY(),l=this.getOffsetX(),m=this.getOffsetY();return(0!==c||0!==d)&&a.translate(c,d),0!==b&&a.rotate(b),(0!==h||0!==k)&&a.skew(h,k),(1!==e||1!==g)&&a.scale(e,g),(0!==l||0!==m)&&a.translate(-1*l,-1*m),this.cachedTransform=a,a},getTransform:function(a){var c=this.cachedTransform;return a&&c?c:this._getAndCacheTransform()},clone:function(a){var c,d,b,e,g;d=this.getClassName();var h=new Kinetic[d](this.attrs);for(c in this.eventListeners)for(d=this.eventListeners[c],b=d.length,e=0;b>e;e++)g=d[e],0>g.name.indexOf("kinetic")&&(h.eventListeners[c]||(h.eventListeners[c]=[]),h.eventListeners[c].push(g));return h.setAttrs(a),h},toDataURL:function(a){a=a||{};var c=a.mimeType||null,d=a.quality||null,b=this.getStage(),e=a.x||0,g=a.y||0;a=new Kinetic.SceneCanvas({width:a.width||b.getWidth(),height:a.height||b.getHeight(),pixelRatio:1});b=a.getContext();return b.save(),(e||g)&&b.translate(-1*e,-1*g),this.drawScene(a),b.restore(),a.toDataURL(c,d)},toImage:function(a){Kinetic.Util._getImage(this.toDataURL(a),function(c){a.callback(c)})},setSize:function(){var a=Kinetic.Util._getSize(Array.prototype.slice.call(arguments));return this.setWidth(a.width),this.setHeight(a.height),this},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return this.attrs.width||0},getHeight:function(){return this.attrs.height||0},getClassName:function(){return this.className||this.nodeType},getType:function(){return this.nodeType},_get:function(a){return this.nodeType===a?[this]:[]},_off:function(a,c){var d,b=this.eventListeners[a];for(d=0;d<b.length;d++)if(b[d].name===c){if(b.splice(d,1),0===b.length){delete this.eventListeners[a];break}d--}},_clearTransform:function(){var a={x:this.getX(),y:this.getY(),rotation:this.getRotation(),scaleX:this.getScaleX(),scaleY:this.getScaleY(),offsetX:this.getOffsetX(),offsetY:this.getOffsetY(),skewX:this.getSkewX(),skewY:this.getSkewY()};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scaleX=1,this.attrs.scaleY=1,this.attrs.offsetX=0,this.attrs.offsetY=0,this.attrs.skewX=0,this.attrs.skewY=0,a},_setTransform:function(a){for(var c in a)this.attrs[c]=a[c];this.cachedTransform=null},_fireBeforeChangeEvent:function(a,c,d){this._fire("before"+Kinetic.Util._capitalize(a)+"Change",{oldVal:c,newVal:d})},_fireChangeEvent:function(a,c,d){this._fire(a+"Change",{oldVal:c,newVal:d})},setId:function(a){var c=this.getId(),d=(this.getStage(),Kinetic.Global);return d._removeId(c),d._addId(this,a),this._setAttr("id",a),this},setName:function(a){var c=this.getName(),d=(this.getStage(),Kinetic.Global);return d._removeName(c,this._id),d._addName(this,a),this._setAttr("name",a),this},_setAttr:function(a,c){var d;void 0!==c&&(d=this.attrs[a],this._fireBeforeChangeEvent(a,d,c),this.attrs[a]=c,this._fireChangeEvent(a,d,c))},_fireAndBubble:function(a,c,d){c&&this.nodeType===b&&(c.targetNode=this);this.getStage();this.eventListeners;var f=!0;"mouseenter"===a&&d&&this._id===d._id?f=!1:"mouseleave"===a&&d&&this._id===d._id&&(f=!1);f&&(this._fire(a,c),c&&!c.cancelBubble&&this.parent&&(d&&d.parent?this._fireAndBubble.call(this.parent,a,c,d.parent):this._fireAndBubble.call(this.parent,a,c)))},_fire:function(a,c){var d,b,e=this.eventListeners[a];if(e)for(d=e.length,b=0;d>b;b++)e[b].handler.call(this,c)},draw:function(){var a={node:this};return this._fire("beforeDraw",a),this.drawScene(),this.drawHit(),this._fire("draw",a),this},shouldDrawHit:function(){return this.isVisible()&&this.isListening()&&!Kinetic.Global.isDragging()},isDraggable:function(){return!1}});Kinetic.Node.setPoints=function(a){a=Kinetic.Util._getPoints(a);this._setAttr("points",a)};Kinetic.Node.addGetterSetter=function(a,c,d,b){this.addGetter(a,c,d);this.addSetter(a,c,b)};Kinetic.Node.addPointGetterSetter=function(a,c,d,b){this.addPointGetter(a,c);this.addPointSetter(a,c);this.addGetter(a,c+"X",d);this.addGetter(a,c+"Y",d);this.addSetter(a,c+"X",b);this.addSetter(a,c+"Y",b)};Kinetic.Node.addPointsGetterSetter=function(a,c){this.addPointsGetter(a,c);this.addPointsSetter(a,c)};Kinetic.Node.addRotationGetterSetter=function(a,c,d,b){this.addRotationGetter(a,c,d);this.addRotationSetter(a,c,b)};Kinetic.Node.addColorGetterSetter=function(a,c){this.addGetter(a,c);this.addSetter(a,c);this.addColorRGBGetter(a,c);this.addColorComponentGetter(a,c,"r");this.addColorComponentGetter(a,c,"g");this.addColorComponentGetter(a,c,"b");this.addColorRGBSetter(a,c);this.addColorComponentSetter(a,c,"r");this.addColorComponentSetter(a,c,"g");this.addColorComponentSetter(a,c,"b")};Kinetic.Node.addColorRGBGetter=function(a,c){var d="get"+Kinetic.Util._capitalize(c)+"RGB";a.prototype[d]=function(){return Kinetic.Util.getRGB(this.attrs[c])}};Kinetic.Node.addColorComponentGetter=function(a,c,d){var b="get"+Kinetic.Util._capitalize(c);c=b+Kinetic.Util._capitalize(d);a.prototype[c]=function(){return this[b+"RGB"]()[d]}};Kinetic.Node.addPointsGetter=function(a,c){var d="get"+Kinetic.Util._capitalize(c);a.prototype[d]=function(){var a=this.attrs[c];return void 0===a?[]:a}};Kinetic.Node.addGetter=function(a,c,d){var b="get"+Kinetic.Util._capitalize(c);a.prototype[b]=function(){var a=this.attrs[c];return void 0===a?d:a}};Kinetic.Node.addPointGetter=function(a,c){var d="get"+Kinetic.Util._capitalize(c);a.prototype[d]=function(){return{x:this[d+"X"](),y:this[d+"Y"]()}}};Kinetic.Node.addRotationGetter=function(a,c,d){var b="get"+Kinetic.Util._capitalize(c);a.prototype[b]=function(){var a=this.attrs[c];return void 0===a&&(a=d),a};a.prototype[b+"Deg"]=function(){var a=this.attrs[c];return void 0===a&&(a=d),Kinetic.Util._radToDeg(a)}};Kinetic.Node.addColorRGBSetter=function(a,c){var d="set"+Kinetic.Util._capitalize(c)+"RGB";a.prototype[d]=function(a){var d=a&&void 0!==a.r?0|a.r:this.getAttr(c+"R"),b=a&&void 0!==a.g?0|a.g:this.getAttr(c+"G");a=a&&void 0!==a.b?0|a.b:this.getAttr(c+"B");this._setAttr(c,"#"+Kinetic.Util._rgbToHex(d,b,a))}};Kinetic.Node.addColorComponentSetter=function(a,c,d){var b="set"+Kinetic.Util._capitalize(c);c=b+Kinetic.Util._capitalize(d);a.prototype[c]=function(a){var c={};c[d]=a;this[b+"RGB"](c)}};Kinetic.Node.addPointsSetter=function(a,c){var d="set"+Kinetic.Util._capitalize(c);a.prototype[d]=Kinetic.Node.setPoints};Kinetic.Node.addSetter=function(a,c,d){var b="set"+Kinetic.Util._capitalize(c);a.prototype[b]=function(a){this._setAttr(c,a);d&&(this.cachedTransform=null)}};Kinetic.Node.addPointSetter=function(a,c){var d="set"+Kinetic.Util._capitalize(c);a.prototype[d]=function(){var a=Kinetic.Util._getXY([].slice.call(arguments)),b=this.attrs[c],g=0,h=0;a&&(g=a.x,h=a.y,this._fireBeforeChangeEvent(c,b,a),void 0!==g&&this[d+"X"](g),void 0!==h&&this[d+"Y"](h),this._fireChangeEvent(c,b,a))}};Kinetic.Node.addRotationSetter=function(a,c,d){var b="set"+Kinetic.Util._capitalize(c);a.prototype[b]=function(a){this._setAttr(c,a);d&&(this.cachedTransform=null)};a.prototype[b+"Deg"]=function(a){this._setAttr(c,Kinetic.Util._degToRad(a));d&&(this.cachedTransform=null)}};Kinetic.Node.create=function(a,c){return this._createNode(JSON.parse(a),c)};Kinetic.Node._createNode=function(a,c){var d,b,e;d=Kinetic.Node.prototype.getClassName.call(a);var g=a.children;if(c&&(a.attrs.container=c),d=new Kinetic[d](a.attrs),g)for(b=g.length,e=0;b>e;e++)d.add(this._createNode(g[e]));return d};Kinetic.Node.addGetterSetter(Kinetic.Node,"x",0,!0);Kinetic.Node.addGetterSetter(Kinetic.Node,"y",0,!0);Kinetic.Node.addGetterSetter(Kinetic.Node,"opacity",1);Kinetic.Node.addGetter(Kinetic.Node,"name");Kinetic.Node.addGetter(Kinetic.Node,"id");Kinetic.Node.addRotationGetterSetter(Kinetic.Node,"rotation",0,!0);Kinetic.Node.addPointGetterSetter(Kinetic.Node,"scale",1,!0);Kinetic.Node.addPointGetterSetter(Kinetic.Node,"skew",0,!0);Kinetic.Node.addPointGetterSetter(Kinetic.Node,"offset",0,!0);Kinetic.Node.addSetter(Kinetic.Node,"width");Kinetic.Node.addSetter(Kinetic.Node,"height");Kinetic.Node.addSetter(Kinetic.Node,"listening");Kinetic.Node.addSetter(Kinetic.Node,"visible");Kinetic.Node.prototype.isListening=Kinetic.Node.prototype.getListening;Kinetic.Node.prototype.isVisible=Kinetic.Node.prototype.getVisible;Kinetic.Collection.mapMethods("on off remove destroy show hide move rotate moveToTop moveUp moveDown moveToBottom moveTo fire draw".split(" "))}();!function(){function b(a){window.setTimeout(a,1E3/60)}Kinetic.Animation=function(a,d){this.func=a;this.setLayers(d);this.id=Kinetic.Animation.animIdCounter++;this.frame={time:0,timeDiff:0,lastTime:(new Date).getTime()}};Kinetic.Animation.prototype={setLayers:function(a){var d=[];this.layers=d=a?0<a.length?a:[a]:[]},getLayers:function(){return this.layers},addLayer:function(a){var d,b,e=this.layers;if(e)for(d=e.length,b=0;d>b;b++){if(e[b]._id===a._id)return!1}else this.layers=[];return this.layers.push(a),!0},isRunning:function(){for(var a=Kinetic.Animation.animations,d=0;d<a.length;d++)if(a[d].id===this.id)return!0;return!1},start:function(){this.stop();this.frame.timeDiff=0;this.frame.lastTime=(new Date).getTime();Kinetic.Animation._addAnimation(this)},stop:function(){Kinetic.Animation._removeAnimation(this)},_updateFrameObject:function(a){this.frame.timeDiff=a-this.frame.lastTime;this.frame.lastTime=a;this.frame.time+=this.frame.timeDiff;this.frame.frameRate=1E3/this.frame.timeDiff}};Kinetic.Animation.animations=[];Kinetic.Animation.animIdCounter=0;Kinetic.Animation.animRunning=!1;Kinetic.Animation._addAnimation=function(a){this.animations.push(a);this._handleAnimation()};Kinetic.Animation._removeAnimation=function(a){a=a.id;for(var d=this.animations,b=d.length,e=0;b>e;e++)if(d[e].id===a){this.animations.splice(e,1);break}};Kinetic.Animation._runFrames=function(){var a,d,b,e,g,h,k,l,m={},n=this.animations;for(e=0;e<n.length;e++){a=n[e];d=a.layers;b=a.func;a._updateFrameObject((new Date).getTime());h=d.length;for(g=0;h>g;g++)k=d[g],void 0!==k._id&&(m[k._id]=k);b&&b.call(a,a.frame)}for(l in m)m[l].draw()};Kinetic.Animation._animationLoop=function(){var a=this;0<this.animations.length?(this._runFrames(),Kinetic.Animation.requestAnimFrame(function(){a._animationLoop()})):this.animRunning=!1};Kinetic.Animation._handleAnimation=function(){this.animRunning||(this.animRunning=!0,this._animationLoop())};RAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||b;Kinetic.Animation.requestAnimFrame=function(a){(Kinetic.DD&&Kinetic.DD.isDragging?b:RAF)(a)};var a=Kinetic.Node.prototype.moveTo;Kinetic.Node.prototype.moveTo=function(b){a.call(this,b)};Kinetic.Layer.batchAnim=new Kinetic.Animation(function(){0===this.getLayers().length&&this.stop();this.setLayers([])});Kinetic.Layer.prototype.batchDraw=function(){var a=Kinetic.Layer.batchAnim;a.addLayer(this);a.isRunning()||a.start()}}();!function(){var b={node:1,duration:1,easing:1,onFinish:1,yoyo:1},a=0;Kinetic.Tween=function(d){var f,e=this,g=d.node,h=g._id,k=d.duration||1,l=d.easing||Kinetic.Easings.Linear,m=!!d.yoyo;this.node=g;this._id=a++;this.onFinish=d.onFinish;this.anim=new Kinetic.Animation(function(){e.tween.onEnterFrame()},g.getLayer()||g.getLayers());this.tween=new c(f,function(a){e._tweenFunc(a)},l,0,1,1E3*k,m);this._addListeners();Kinetic.Tween.attrs[h]||(Kinetic.Tween.attrs[h]={});Kinetic.Tween.attrs[h][this._id]||(Kinetic.Tween.attrs[h][this._id]={});Kinetic.Tween.tweens[h]||(Kinetic.Tween.tweens[h]={});for(f in d)void 0===b[f]&&this._addAttr(f,d[f]);this.reset()};Kinetic.Tween.attrs={};Kinetic.Tween.tweens={};Kinetic.Tween.prototype={_addAttr:function(a,b){var c,g,h,k,l,m;c=this.node;var n=c._id;if(g=Kinetic.Tween.tweens[n][a],g&&delete Kinetic.Tween.attrs[n][g][a],c=c.getAttr(a),Kinetic.Util._isArray(b))for(b=Kinetic.Util._getPoints(b),g=[],k=b.length,h=0;k>h;h++)l=c[h],m=b[h],g.push({x:m.x-l.x,y:m.y-l.y});else g=b-c;Kinetic.Tween.attrs[n][this._id][a]={start:c,diff:g};Kinetic.Tween.tweens[n][a]=this._id},_tweenFunc:function(a){var b,c,g,h,k,l,m,n,p,r=this.node,s=Kinetic.Tween.attrs[r._id][this._id];for(b in s){if(c=s[b],g=c.start,h=c.diff,Kinetic.Util._isArray(g))for(k=[],m=g.length,l=0;m>l;l++)n=g[l],p=h[l],k.push({x:n.x+p.x*a,y:n.y+p.y*a});else k=g+h*a;r.setAttr(b,k)}},_addListeners:function(){var a=this;this.tween.onPlay=function(){a.anim.start()};this.tween.onReverse=function(){a.anim.start()};this.tween.onPause=function(){a.anim.stop()};this.tween.onFinish=function(){a.onFinish&&a.onFinish()}},play:function(){return this.tween.play(),this},reverse:function(){return this.tween.reverse(),this},reset:function(){var a=this.node;return this.tween.reset(),(a.getLayer()||a.getLayers()).draw(),this},seek:function(a){var b=this.node;return this.tween.seek(1E3*a),(b.getLayer()||b.getLayers()).draw(),this},pause:function(){return this.tween.pause(),this},finish:function(){var a=this.node;return this.tween.finish(),(a.getLayer()||a.getLayers()).draw(),this},destroy:function(){var a,b=this.node._id,c=this._id,g=Kinetic.Tween.tweens[b];this.pause();for(a in g)delete Kinetic.Tween.tweens[b][a];delete Kinetic.Tween.attrs[b][c]}};var c=function(a,b,c,g,h,k,l){this.prop=a;this.propFunc=b;this._pos=this.begin=g;this.duration=k;this.prevPos=this._change=0;this.yoyo=l;this._finish=this._startTime=this._position=this._time=0;this.func=c;this._change=h-this.begin;this.pause()};c.prototype={fire:function(a){(a=this[a])&&a()},setTime:function(a){a>this.duration?this.yoyo?(this._time=this.duration,this.reverse()):this.finish():0>a?this.yoyo?(this._time=0,this.play()):this.reset():(this._time=a,this.update())},getTime:function(){return this._time},setPosition:function(a){this.prevPos=this._pos;this.propFunc(a);this._pos=a},getPosition:function(a){return void 0===a&&(a=this._time),this.func(a,this.begin,this._change,this.duration)},play:function(){this.state=2;this._startTime=this.getTimer()-this._time;this.onEnterFrame();this.fire("onPlay")},reverse:function(){this.state=3;this._time=this.duration-this._time;this._startTime=this.getTimer()-this._time;this.onEnterFrame();this.fire("onReverse")},seek:function(a){this.pause();this._time=a;this.update();this.fire("onSeek")},reset:function(){this.pause();this._time=0;this.update();this.fire("onReset")},finish:function(){this.pause();this._time=this.duration;this.update();this.fire("onFinish")},update:function(){this.setPosition(this.getPosition(this._time))},onEnterFrame:function(){var a=this.getTimer()-this._startTime;2===this.state?this.setTime(a):3===this.state&&this.setTime(this.duration-a)},pause:function(){this.state=1;this.fire("onPause")},getTimer:function(){return(new Date).getTime()}};Kinetic.Easings={BackEaseIn:function(a,b,c,g){return c*(a/=g)*a*(2.70158*a-1.70158)+b},BackEaseOut:function(a,b,c,g){return c*((a=a/g-1)*a*(2.70158*a+1.70158)+1)+b},BackEaseInOut:function(a,b,c,g){var h=1.70158;return 1>(a/=g/2)?c/2*a*a*(((h*=1.525)+1)*a-h)+b:c/2*((a-=2)*a*(((h*=1.525)+1)*a+h)+2)+b},ElasticEaseIn:function(a,b,c,g,h,k){var l=0;return 0===a?b:1==(a/=g)?b+c:(k||(k=0.3*g),!h||h<Math.abs(c)?(h=c,l=k/4):l=k/(2*Math.PI)*Math.asin(c/h),-(h*Math.pow(2,10*(a-=1))*Math.sin(2*(a*g-l)*Math.PI/k))+b)},ElasticEaseOut:function(a,b,c,g,h,k){var l=0;return 0===a?b:1==(a/=g)?b+c:(k||(k=0.3*g),!h||h<Math.abs(c)?(h=c,l=k/4):l=k/(2*Math.PI)*Math.asin(c/h),h*Math.pow(2,-10*a)*Math.sin(2*(a*g-l)*Math.PI/k)+c+b)},ElasticEaseInOut:function(a,b,c,g,h,k){var l=0;return 0===a?b:2==(a/=g/2)?b+c:(k||(k=1.5*0.3*g),!h||h<Math.abs(c)?(h=c,l=k/4):l=k/(2*Math.PI)*Math.asin(c/h),1>a?-0.5*h*Math.pow(2,10*(a-=1))*Math.sin(2*(a*g-l)*Math.PI/k)+b:0.5*h*Math.pow(2,-10*(a-=1))*Math.sin(2*(a*g-l)*Math.PI/k)+c+b)},BounceEaseOut:function(a,b,c,g){return(a/=g)<1/2.75?7.5625*c*a*a+b:2/2.75>a?c*(7.5625*(a-=1.5/2.75)*a+0.75)+b:2.5/2.75>a?c*(7.5625*(a-=2.25/2.75)*a+0.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+0.984375)+b},BounceEaseIn:function(a,b,c,g){return c-Kinetic.Easings.BounceEaseOut(g-a,0,c,g)+b},BounceEaseInOut:function(a,b,c,g){return g/2>a?0.5*Kinetic.Easings.BounceEaseIn(2*a,0,c,g)+b:0.5*Kinetic.Easings.BounceEaseOut(2*a-g,0,c,g)+0.5*c+b},EaseIn:function(a,b,c,g){return c*(a/=g)*a+b},EaseOut:function(a,b,c,g){return-c*(a/=g)*(a-2)+b},EaseInOut:function(a,b,c,g){return 1>(a/=g/2)?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},StrongEaseIn:function(a,b,c,g){return c*(a/=g)*a*a*a*a+b},StrongEaseOut:function(a,b,c,g){return c*((a=a/g-1)*a*a*a*a+1)+b},StrongEaseInOut:function(a,b,c,g){return 1>(a/=g/2)?c/2*a*a*a*a*a+b:c/2*((a-=2)*a*a*a*a+2)+b},Linear:function(a,b,c,g){return c*a/g+b}}}();!function(){Kinetic.Util.addMethods(Kinetic.Container,{_containerInit:function(b){this.children=new Kinetic.Collection;Kinetic.Node.call(this,b)},getChildren:function(){return this.children},hasChildren:function(){return 0<this.getChildren().length},removeChildren:function(){for(var b,a=this.children;0<a.length;)b=a[0],b.hasChildren()&&b.removeChildren(),b.remove();return this},destroyChildren:function(){for(var b=this.children;0<b.length;)b[0].destroy();return this},add:function(b){var a=(Kinetic.Global,this.children);return b.index=a.length,b.parent=this,a.push(b),this._fire("add",{child:b}),this},destroy:function(){this.hasChildren()&&this.destroyChildren();Kinetic.Node.prototype.destroy.call(this)},get:function(b){var a=new Kinetic.Collection;if("#"===b.charAt(0))(b=this._getNodeById(b.slice(1)))&&a.push(b);else if("."===b.charAt(0))b=this._getNodesByName(b.slice(1)),Kinetic.Collection.apply(a,b);else{for(var c=[],d=this.getChildren(),f=d.length,e=0;f>e;e++)c=c.concat(d[e]._get(b));Kinetic.Collection.apply(a,c)}return a},_getNodeById:function(b){b=(this.getStage(),Kinetic.Global).ids[b];return void 0!==b&&this.isAncestorOf(b)?b:null},_getNodesByName:function(b){return this._getDescendants(Kinetic.Global.names[b]||[])},_get:function(b){for(var a=Kinetic.Node.prototype._get.call(this,b),c=this.getChildren(),d=c.length,f=0;d>f;f++)a=a.concat(c[f]._get(b));return a},toObject:function(){var b=Kinetic.Node.prototype.toObject.call(this);b.children=[];for(var a=this.getChildren(),c=a.length,d=0;c>d;d++)b.children.push(a[d].toObject());return b},_getDescendants:function(b){for(var a=[],c=b.length,d=0;c>d;d++){var f=b[d];this.isAncestorOf(f)&&a.push(f)}return a},isAncestorOf:function(b){for(b=b.getParent();b;){if(b._id===this._id)return!0;b=b.getParent()}return!1},clone:function(b){var a=Kinetic.Node.prototype.clone.call(this,b);return this.getChildren().each(function(b){a.add(b.clone())}),a},getAllIntersections:function(){for(var b=Kinetic.Util._getXY(Array.prototype.slice.call(arguments)),a=[],c=this.get("Shape"),d=c.length,f=0;d>f;f++){var e=c[f];e.isVisible()&&e.intersects(b)&&a.push(e)}return a},_setChildrenIndices:function(){for(var b=this.children,a=b.length,c=0;a>c;c++)b[c].index=c},drawScene:function(b){var a,c,d;a=this.getLayer();var f=!!this.getClipFunc();if(!b&&a&&(b=a.getCanvas()),this.isVisible()){f&&b._clip(this);a=this.children;d=a.length;for(c=0;d>c;c++)a[c].drawScene(b);f&&b.getContext().restore()}return this},drawHit:function(){var b,a=!!this.getClipFunc()&&"Stage"!==this.nodeType,c=0,d=0,f=[];if(this.shouldDrawHit()){a&&(b=this.getLayer().hitCanvas,b._clip(this));f=this.children;d=f.length;for(c=0;d>c;c++)f[c].drawHit();a&&b.getContext().restore()}return this}});Kinetic.Util.extend(Kinetic.Container,Kinetic.Node);Kinetic.Node.addGetterSetter(Kinetic.Container,"clipFunc")}();!function(){function b(a){a.fill()}function a(a){a.stroke()}function c(a){a.fill()}function d(a){a.stroke()}Kinetic.Util.addMethods(Kinetic.Shape,{_initShape:function(f){this.nodeType="Shape";this._fillFunc=b;this._strokeFunc=a;this._fillFuncHit=c;this._strokeFuncHit=d;for(var e,g=Kinetic.Global.shapes;e=Kinetic.Util.getRandomColor(),!e||e in g;);this.colorKey=e;g[e]=this;this.createAttrs();Kinetic.Node.call(this,f)},hasChildren:function(){return!1},getChildren:function(){return[]},getContext:function(){return this.getLayer().getContext()},getCanvas:function(){return this.getLayer().getCanvas()},hasShadow:function(){return!!(this.getShadowColor()||this.getShadowBlur()||this.getShadowOffsetX()||this.getShadowOffsetY())},hasFill:function(){return!!(this.getFill()||this.getFillPatternImage()||this.getFillLinearGradientColorStops()||this.getFillRadialGradientColorStops())},_get:function(a){return this.className===a||this.nodeType===a?[this]:[]},intersects:function(){var a=Kinetic.Util._getXY(Array.prototype.slice.call(arguments)),b=this.getStage().hitCanvas;b.clear();this.drawScene(b);return 0<b.context.getImageData(0|a.x,0|a.y,1,1).data[3]},enableFill:function(){return this._setAttr("fillEnabled",!0),this},disableFill:function(){return this._setAttr("fillEnabled",!1),this},enableStroke:function(){return this._setAttr("strokeEnabled",!0),this},disableStroke:function(){return this._setAttr("strokeEnabled",!1),this},enableStrokeScale:function(){return this._setAttr("strokeScaleEnabled",!0),this},disableStrokeScale:function(){return this._setAttr("strokeScaleEnabled",!1),this},enableShadow:function(){return this._setAttr("shadowEnabled",!0),this},disableShadow:function(){return this._setAttr("shadowEnabled",!1),this},enableDashArray:function(){return this._setAttr("dashArrayEnabled",!0),this},disableDashArray:function(){return this._setAttr("dashArrayEnabled",!1),this},destroy:function(){return Kinetic.Node.prototype.destroy.call(this),delete Kinetic.Global.shapes[this.colorKey],this},drawScene:function(a){a=a||this.getLayer().getCanvas();var b=this.getDrawFunc(),c=a.getContext();return b&&this.isVisible()&&(c.save(),a._applyOpacity(this),a._applyLineJoin(this),a._applyAncestorTransforms(this),b.call(this,a),c.restore()),this},drawHit:function(){var a=this.getAttrs(),a=a.drawHitFunc||a.drawFunc,b=this.getLayer().hitCanvas,c=b.getContext();return a&&this.shouldDrawHit()&&(c.save(),b._applyLineJoin(this),b._applyAncestorTransforms(this),a.call(this,b),c.restore()),this},_setDrawFuncs:function(){!this.attrs.drawFunc&&this.drawFunc&&this.setDrawFunc(this.drawFunc);!this.attrs.drawHitFunc&&this.drawHitFunc&&this.setDrawHitFunc(this.drawHitFunc)}});Kinetic.Util.extend(Kinetic.Shape,Kinetic.Node);Kinetic.Node.addColorGetterSetter(Kinetic.Shape,"stroke");Kinetic.Node.addGetterSetter(Kinetic.Shape,"lineJoin");Kinetic.Node.addGetterSetter(Kinetic.Shape,"lineCap");Kinetic.Node.addGetterSetter(Kinetic.Shape,"strokeWidth");Kinetic.Node.addGetterSetter(Kinetic.Shape,"drawFunc");Kinetic.Node.addGetterSetter(Kinetic.Shape,"drawHitFunc");Kinetic.Node.addGetterSetter(Kinetic.Shape,"dashArray");Kinetic.Node.addColorGetterSetter(Kinetic.Shape,"shadowColor");Kinetic.Node.addGetterSetter(Kinetic.Shape,"shadowBlur");Kinetic.Node.addGetterSetter(Kinetic.Shape,"shadowOpacity");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillPatternImage");Kinetic.Node.addColorGetterSetter(Kinetic.Shape,"fill");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillPatternX");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillPatternY");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillLinearGradientColorStops");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillRadialGradientStartRadius");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillRadialGradientEndRadius");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillRadialGradientColorStops");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillPatternRepeat");Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillEnabled",!0);Kinetic.Node.addGetterSetter(Kinetic.Shape,"strokeEnabled",!0);Kinetic.Node.addGetterSetter(Kinetic.Shape,"shadowEnabled",!0);Kinetic.Node.addGetterSetter(Kinetic.Shape,"dashArrayEnabled",!0);Kinetic.Node.addGetterSetter(Kinetic.Shape,"fillPriority","color");Kinetic.Node.addGetterSetter(Kinetic.Shape,"strokeScaleEnabled",!0);Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillPatternOffset",0);Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillPatternScale",1);Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillLinearGradientStartPoint",0);Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillLinearGradientEndPoint",0);Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillRadialGradientStartPoint",0);Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"fillRadialGradientEndPoint",0);Kinetic.Node.addPointGetterSetter(Kinetic.Shape,"shadowOffset",0);Kinetic.Node.addRotationGetterSetter(Kinetic.Shape,"fillPatternRotation",0)}();!function(){function b(b,c){b.content.addEventListener(c,function(d){d.preventDefault();b[a+c](d)},!1)}var a="_",c="mousedown mousemove mouseup mouseout touchstart touchmove touchend".split(" "),d=c.length;Kinetic.Util.addMethods(Kinetic.Stage,{_initStage:function(a){this.createAttrs();Kinetic.Container.call(this,a);this.nodeType="Stage";this.dblClickWindow=400;this._id=Kinetic.Global.idCounter++;this._buildDOM();this._bindContentEvents();Kinetic.Global.stages.push(this)},setContainer:function(a){return"string"===typeof a&&(a=document.getElementById(a)),this._setAttr("container",a),this},draw:function(){var a,b,c=this.getChildren(),d=c.length;for(a=0;d>a;a++)b=c[a],b.getClearBeforeDraw()&&(b.getCanvas().clear(),b.getHitCanvas().clear());return Kinetic.Node.prototype.draw.call(this),this},setHeight:function(a){return Kinetic.Node.prototype.setHeight.call(this,a),this._resizeDOM(),this},setWidth:function(a){return Kinetic.Node.prototype.setWidth.call(this,a),this._resizeDOM(),this},clear:function(){var a,b=this.children,c=b.length;for(a=0;c>a;a++)b[a].clear();return this},destroy:function(){var a=this.content;Kinetic.Container.prototype.destroy.call(this);a&&Kinetic.Util._isInDocument(a)&&this.getContainer().removeChild(a)},getMousePosition:function(){return this.mousePos},getTouchPosition:function(){return this.touchPos},getPointerPosition:function(){return this.getTouchPosition()||this.getMousePosition()},getStage:function(){return this},getContent:function(){return this.content},toDataURL:function(a){function b(k){var l=p[k].toDataURL(),q=new Image;q.onload=function(){n.drawImage(q,0,0);k<p.length-1?b(k+1):a.callback(m.toDataURL(c,d))};q.src=l}a=a||{};var c=a.mimeType||null,d=a.quality||null,k=a.x||0,l=a.y||0,m=new Kinetic.SceneCanvas({width:a.width||this.getWidth(),height:a.height||this.getHeight(),pixelRatio:1}),n=m.getContext(),p=this.children;(k||l)&&n.translate(-1*k,-1*l);b(0)},toImage:function(a){var b=a.callback;a.callback=function(a){Kinetic.Util._getImage(a,function(a){b(a)})};this.toDataURL(a)},getIntersection:function(){var a,b,c=Kinetic.Util._getXY(Array.prototype.slice.call(arguments)),d=this.getChildren();for(a=d.length-1;0<=a;a--)if(b=d[a].getIntersection(c))return b;return null},_resizeDOM:function(){if(this.content){var a,b=this.getWidth(),c=this.getHeight(),d=this.getChildren(),k=d.length;this.content.style.width=b+"px";this.content.style.height=c+"px";this.bufferCanvas.setSize(b,c,1);this.hitCanvas.setSize(b,c);for(a=0;k>a;a++)layer=d[a],layer.getCanvas().setSize(b,c),layer.hitCanvas.setSize(b,c),layer.draw()}},add:function(a){return Kinetic.Container.prototype.add.call(this,a),a.canvas.setSize(this.attrs.width,this.attrs.height),a.hitCanvas.setSize(this.attrs.width,this.attrs.height),a.draw(),this.content.appendChild(a.canvas.element),this},getParent:function(){return null},getLayer:function(){return null},getLayers:function(){return this.getChildren()},_setPointerPosition:function(a){a||(a=window.event);this._setMousePosition(a);this._setTouchPosition(a)},_bindContentEvents:function(){var a;for(a=0;d>a;a++)b(this,c[a])},_mouseout:function(a){this._setPointerPosition(a);var b=Kinetic.Global,c=this.targetShape;c&&!b.isDragging()&&(c._fireAndBubble("mouseout",a),c._fireAndBubble("mouseleave",a),this.targetShape=null);this.mousePos=void 0},_mousemove:function(a){this._setPointerPosition(a);var b,c=Kinetic.Global,d=Kinetic.DD,k=this.getIntersection(this.getPointerPosition());k?(b=k.shape,b&&(c.isDragging()||255!==k.pixel[3]||this.targetShape&&this.targetShape._id===b._id?b._fireAndBubble("mousemove",a):(this.targetShape&&(this.targetShape._fireAndBubble("mouseout",a,b),this.targetShape._fireAndBubble("mouseleave",a,b)),b._fireAndBubble("mouseover",a,this.targetShape),b._fireAndBubble("mouseenter",a,this.targetShape),this.targetShape=b))):this.targetShape&&!c.isDragging()&&(this.targetShape._fireAndBubble("mouseout",a),this.targetShape._fireAndBubble("mouseleave",a),this.targetShape=null);d&&d._drag(a)},_mousedown:function(a){this._setPointerPosition(a);var b,c=Kinetic.Global,d=this.getIntersection(this.getPointerPosition());d&&d.shape&&(b=d.shape,this.clickStart=!0,this.clickStartShape=b,b._fireAndBubble("mousedown",a));this.isDraggable()&&!c.isDragReady()&&this.startDrag(a)},_mouseup:function(a){this._setPointerPosition(a);var b,c=this,d=Kinetic.Global,k=this.getIntersection(this.getPointerPosition());k&&k.shape&&(b=k.shape,b._fireAndBubble("mouseup",a),this.clickStart&&(d.isDragging()||b._id!==this.clickStartShape._id||(b._fireAndBubble("click",a),this.inDoubleClickWindow&&b._fireAndBubble("dblclick",a),this.inDoubleClickWindow=!0,setTimeout(function(){c.inDoubleClickWindow=!1},this.dblClickWindow))));this.clickStart=!1},_touchstart:function(a){this._setPointerPosition(a);var b,c=Kinetic.Global,d=this.getIntersection(this.getPointerPosition());d&&d.shape&&(b=d.shape,this.tapStart=!0,this.tapStartShape=b,b._fireAndBubble("touchstart",a));this.isDraggable()&&!c.isDragReady()&&this.startDrag(a)},_touchend:function(a){this._setPointerPosition(a);var b,c=this,d=Kinetic.Global,k=this.getIntersection(this.getPointerPosition());k&&k.shape&&(b=k.shape,b._fireAndBubble("touchend",a),this.tapStart&&(d.isDragging()||b._id!==this.tapStartShape._id||(b._fireAndBubble("tap",a),this.inDoubleClickWindow&&b._fireAndBubble("dbltap",a),this.inDoubleClickWindow=!0,setTimeout(function(){c.inDoubleClickWindow=!1},this.dblClickWindow))));this.tapStart=!1},_touchmove:function(a){this._setPointerPosition(a);var b,c=Kinetic.DD,d=this.getIntersection(this.getPointerPosition());d&&d.shape&&(b=d.shape,b._fireAndBubble("touchmove",a));c&&c._drag(a)},_setMousePosition:function(a){var b=a.clientX-this._getContentPosition().left;a=a.clientY-this._getContentPosition().top;this.mousePos={x:b,y:a}},_setTouchPosition:function(a){var b,c,d;void 0!==a.touches&&1===a.touches.length&&(b=a.touches[0],c=b.clientX-this._getContentPosition().left,d=b.clientY-this._getContentPosition().top,this.touchPos={x:c,y:d})},_getContentPosition:function(){var a=this.content.getBoundingClientRect();return{top:a.top,left:a.left}},_buildDOM:function(){var a=this.getContainer();a.innerHTML="";this.content=document.createElement("div");this.content.style.position="relative";this.content.style.display="inline-block";this.content.className="kineticjs-content";a.appendChild(this.content);this.bufferCanvas=new Kinetic.SceneCanvas;this.hitCanvas=new Kinetic.HitCanvas;this._resizeDOM()},_onContent:function(a,b){var c,d,k=a.split(" "),l=k.length;for(c=0;l>c;c++)d=k[c],this.content.addEventListener(d,b,!1)}});Kinetic.Util.extend(Kinetic.Stage,Kinetic.Container);Kinetic.Node.addGetter(Kinetic.Stage,"container")}();!function(){Kinetic.Util.addMethods(Kinetic.Layer,{_initLayer:function(b){this.nodeType="Layer";this.createAttrs();this.canvas=new Kinetic.SceneCanvas;this.canvas.getElement().style.position="absolute";this.hitCanvas=new Kinetic.HitCanvas;Kinetic.Container.call(this,b)},getIntersection:function(){var b,a,c,d=Kinetic.Util._getXY(Array.prototype.slice.call(arguments));if(this.isVisible()&&this.isListening()){if(b=this.hitCanvas.context.getImageData(0|d.x,0|d.y,1,1).data,255===b[3])return a=Kinetic.Util._rgbToHex(b[0],b[1],b[2]),c=Kinetic.Global.shapes["#"+a],{shape:c,pixel:b};if(0<b[0]||0<b[1]||0<b[2]||0<b[3])return{pixel:b}}return null},drawScene:function(b){return b=b||this.getCanvas(),this.getClearBeforeDraw()&&b.clear(),Kinetic.Container.prototype.drawScene.call(this,b),this},drawHit:function(){var b=this.getLayer();return b&&b.getClearBeforeDraw()&&b.getHitCanvas().clear(),Kinetic.Container.prototype.drawHit.call(this),this},getCanvas:function(){return this.canvas},getHitCanvas:function(){return this.hitCanvas},getContext:function(){return this.getCanvas().getContext()},clear:function(){return this.getCanvas().clear(),this},setVisible:function(b){return Kinetic.Node.prototype.setVisible.call(this,b),b?(this.getCanvas().element.style.display="block",this.hitCanvas.element.style.display="block"):(this.getCanvas().element.style.display="none",this.hitCanvas.element.style.display="none"),this},setZIndex:function(b){Kinetic.Node.prototype.setZIndex.call(this,b);var a=this.getStage();return a&&(a.content.removeChild(this.getCanvas().element),b<a.getChildren().length-1?a.content.insertBefore(this.getCanvas().element,a.getChildren()[b+1].getCanvas().element):a.content.appendChild(this.getCanvas().element)),this},moveToTop:function(){Kinetic.Node.prototype.moveToTop.call(this);var b=this.getStage();b&&(b.content.removeChild(this.getCanvas().element),b.content.appendChild(this.getCanvas().element))},moveUp:function(){if(Kinetic.Node.prototype.moveUp.call(this)){var b=this.getStage();b&&(b.content.removeChild(this.getCanvas().element),this.index<b.getChildren().length-1?b.content.insertBefore(this.getCanvas().element,b.getChildren()[this.index+1].getCanvas().element):b.content.appendChild(this.getCanvas().element))}},moveDown:function(){if(Kinetic.Node.prototype.moveDown.call(this)){var b=this.getStage();if(b){var a=b.getChildren();b.content.removeChild(this.getCanvas().element);b.content.insertBefore(this.getCanvas().element,a[this.index+1].getCanvas().element)}}},moveToBottom:function(){if(Kinetic.Node.prototype.moveToBottom.call(this)){var b=this.getStage();if(b){var a=b.getChildren();b.content.removeChild(this.getCanvas().element);b.content.insertBefore(this.getCanvas().element,a[1].getCanvas().element)}}},getLayer:function(){return this},remove:function(){var b=this.getStage(),a=this.getCanvas(),c=a.element;return Kinetic.Node.prototype.remove.call(this),b&&a&&Kinetic.Util._isInDocument(c)&&b.content.removeChild(c),this}});Kinetic.Util.extend(Kinetic.Layer,Kinetic.Container);Kinetic.Node.addGetterSetter(Kinetic.Layer,"clearBeforeDraw",!0)}();!function(){Kinetic.Util.addMethods(Kinetic.Group,{_initGroup:function(b){this.nodeType="Group";this.createAttrs();Kinetic.Container.call(this,b)}});Kinetic.Util.extend(Kinetic.Group,Kinetic.Container)}();!function(){Kinetic.Rect=function(b){this._initRect(b)};Kinetic.Rect.prototype={_initRect:function(b){this.createAttrs();Kinetic.Shape.call(this,b);this.className="Rect";this._setDrawFuncs()},drawFunc:function(b){var a=b.getContext(),c=this.getCornerRadius(),d=this.getWidth(),f=this.getHeight();a.beginPath();c?(a.moveTo(c,0),a.lineTo(d-c,0),a.arc(d-c,c,c,3*Math.PI/2,0,!1),a.lineTo(d,f-c),a.arc(d-c,f-c,c,0,Math.PI/2,!1),a.lineTo(c,f),a.arc(c,f-c,c,Math.PI/2,Math.PI,!1),a.lineTo(0,c),a.arc(c,c,c,Math.PI,3*Math.PI/2,!1)):a.rect(0,0,d,f);a.closePath();b.fillStroke(this)}};Kinetic.Util.extend(Kinetic.Rect,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.Rect,"cornerRadius",0)}();!function(){Kinetic.Wedge=function(b){this._initWedge(b)};Kinetic.Wedge.prototype={_initWedge:function(b){this.createAttrs();Kinetic.Shape.call(this,b);this.className="Wedge";this._setDrawFuncs()},drawFunc:function(b){var a=b.getContext();a.beginPath();a.arc(0,0,this.getRadius(),0,this.getAngle(),this.getClockwise());a.lineTo(0,0);a.closePath();b.fillStroke(this)}};Kinetic.Util.extend(Kinetic.Wedge,Kinetic.Shape);Kinetic.Node.addGetterSetter(Kinetic.Wedge,"radius",0);Kinetic.Node.addRotationGetterSetter(Kinetic.Wedge,"angle",0);Kinetic.Node.addGetterSetter(Kinetic.Wedge,"clockwise",!1)}();!function(){Kinetic.Image=function(b){this._initImage(b)};Kinetic.Image.prototype={_initImage:function(b){Kinetic.Shape.call(this,b);this.className="Image";this._setDrawFuncs()},drawFunc:function(b){var a,c,d,f,e,g,h=this.getWidth(),k=this.getHeight(),l=this,m=b.getContext(),n=this.getCrop();this.getFilter()&&this._applyFilter&&(this.applyFilter(),this._applyFilter=!1);g=this.filterCanvas?this.filterCanvas.getElement():this.getImage();m.beginPath();m.rect(0,0,h,k);m.closePath();b.fillStroke(this);g&&(n?(c=n.x||0,d=n.y||0,f=n.width||0,e=n.height||0,a=[g,c,d,f,e,0,0,h,k]):a=[g,0,0,h,k],this.hasShadow()?b.applyShadow(this,function(){l._drawImage(m,a)}):this._drawImage(m,a))},drawHitFunc:function(b){var a=this.getWidth(),c=this.getHeight(),d=this.imageHitRegion,f=b.getContext();d?(f.drawImage(d,0,0,a,c),f.beginPath(),f.rect(0,0,a,c),f.closePath(),b.stroke(this)):(f.beginPath(),f.rect(0,0,a,c),f.closePath(),b.fillStroke(this))},applyFilter:function(){var b,a,c,d=this.getImage(),f=this.getWidth(),e=this.getHeight(),g=this.getFilter();b=this.filterCanvas?this.filterCanvas:this.filterCanvas=new Kinetic.SceneCanvas({width:f,height:e});a=b.getContext();try{this._drawImage(a,[d,0,0,f,e]),c=a.getImageData(0,0,b.getWidth(),b.getHeight()),g.call(this,c),a.putImageData(c,0,0)}catch(h){this.clearFilter(),Kinetic.Util.warn("Unable to apply filter. "+h.message)}},clearFilter:function(){this.filterCanvas=null;this._applyFilter=!1},setCrop:function(){var b=[].slice.call(arguments),a=Kinetic.Util._getXY(b),b=Kinetic.Util._getSize(b),a=Kinetic.Util._merge(a,b);this._setAttr("crop",Kinetic.Util._merge(a,this.getCrop()))},createImageHitRegion:function(b){var a,c,d,f,e,g=this,h=this.getWidth(),k=this.getHeight(),l=(new Kinetic.Canvas({width:h,height:k})).getContext(),m=this.getImage();l.drawImage(m,0,0);try{a=l.getImageData(0,0,h,k);c=a.data;d=Kinetic.Util._hexToRgb(this.colorKey);f=0;for(e=c.length;e>f;f+=4)0<c[f+3]&&(c[f]=d.r,c[f+1]=d.g,c[f+2]=d.b);Kinetic.Util._getImage(a,function(a){g.imageHitRegion=a;b&&b()})}catch(n){Kinetic.Util.warn("Unable to create image hit region. "+n.message)}},clearImageHitRegion:function(){delete this.imageHitRegion},getWidth:function(){var b=this.getImage();return this.attrs.width||(b?b.width:0)},getHeight:function(){var b=this.getImage();return this.attrs.height||(b?b.height:0)},_drawImage:function(b,a){5===a.length?b.drawImage(a[0],a[1],a[2],a[3],a[4]):9===a.length&&b.drawImage(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])}};Kinetic.Util.extend(Kinetic.Image,Kinetic.Shape);Kinetic.Node.addFilterGetterSetter=function(b,a,c){this.addGetter(b,a,c);this.addFilterSetter(b,a)};Kinetic.Node.addFilterSetter=function(b,a){var c="set"+Kinetic.Util._capitalize(a);b.prototype[c]=function(b){this._setAttr(a,b);this._applyFilter=!0}};Kinetic.Node.addGetterSetter(Kinetic.Image,"image");Kinetic.Node.addGetter(Kinetic.Image,"crop");Kinetic.Node.addFilterGetterSetter(Kinetic.Image,"filter")}();if(navigator.isCocoonJS){console.log("User Agent: "+navigator.userAgent);console.log("Platform: "+navigator.platform);console.log("Vendor: "+navigator.vendor);console.log("App Version: "+navigator.appVersion);console.log("Browser: "+navigator.browser);document._createElement=document.createElement;var firstCanvas=!0;document.createElement=function(b){"canvas"===b&&firstCanvas&&(firstCanvas=!1,b="screencanvas");return this._createElement(b)}}(function(){var b=[],a;for(a in Kinetic)for(var c in Kinetic[a].prototype)if("_nodeInit"===c){b.push(Kinetic[a].prototype);break}a=function(a,c){b.forEach(function(b){var g=c,h=b[a];h&&(g=function(){h.apply(this,arguments);c.apply(this,arguments)});b[a]=g})};Kinetic.Util.addMethods(Kinetic.Stage,{_getContentPosition:function(){var a=this.content.getBoundingClientRect?this.content.getBoundingClientRect():{top:0,left:0};return{top:a.top,left:a.left}}});Kinetic.Util.addMethods(Kinetic.Group,{size:function(){return this.getChildren().length},each:function(a){this.getChildren().forEach(a)},centerHorizontally:function(a){a.setX((this.getWidth()-a.getWidth())/2)},centerVertically:function(a){a.setY((this.getHeight()-a.getHeight())/2)},center:function(a){this.centerHorizontally(a);this.centerVertically(a)}});a("toLocalOf",function(a){a=a.getAbsolutePosition();var b=this.getAbsoluteTransform();b.invert();b.translate(a.x,a.y);a=b.getTranslation();return{x:this.getX()+a.x,y:this.getY()+a.y}});a("isTweening",function(){return this.tween&&this.tween.anim.isRunning()});a("destroyTween",function(){this.tween&&this.tween.destroy()});a("finishTween",function(){this.tween&&this.tween.finish()});a("to",function(a){var b=a.callback;a.onFinish=b?function(){this.tween.destroy();b.call(this)}.bind(this):void 0;a.easing=Kinetic.Easings[a.easing];a.node=this;delete a.callback;this.destroyTween();this.tween=new Kinetic.Tween(a);this.tween.play();return this.tween});a("destroy",function(){this.destroyTween()});b=a=void 0})();Array.isArray||(Array.isArray=function(b){return"[object Array]"===Object.prototype.toString.call(b)});Array.prototype.forEach||(Array.prototype.forEach=function(b,a){if(this.length===+this.length)for(var c=0,d=this.length;c<d;c++)c in this&&b.call(a,this[c],c,this);else for(c in this)Object.prototype.hasOwnProperty.call(this,c)&&b.call(a,this[c],c,this)});if(!Array.prototype.indexOf){var sortedIndex=function(b,a,c){c||(c=function(a){return a});for(var d=0,f=b.length;d<f;){var e=d+f>>1;c(b[e])<c(a)?d=e+1:f=e}return d};Array.prototype.indexOf=function(b,a){var c,d;if(a)return c=sortedIndex(array,b),this[c]===b?c:-1;c=0;for(d=this.length;c<d;)return c in this&&this[c]===b?c:-1}}Array.prototype.isEmpty=function(){return 0===this.length};Array.prototype.contains=function(b){return-1!=this.indexOf(b)};Array.prototype.add=function(b){this.push(b);return this};Array.prototype.last=function(){return this[this.length-1]};Array.prototype.first=function(){return this[0]};Array.prototype.remove=function(b){b=this.indexOf(b);-1!=b&&this.splice(b,1);return this};Array.prototype.clone=function(){return this.slice()};Function.prototype.repeat=function(b){for(var a=0;a<b;a++)this.call();return this};Function.prototype.bind||(Function.prototype.bind=function(b){function a(){return d.apply(this instanceof f?this:b||window,c.concat(Array.prototype.slice.call(arguments)))}var c=Array.prototype.slice.call(arguments,1),d=this,f=function(){};f.prototype=this.prototype;a.prototype=new f;return a});String.prototype.contains=function(b){return 0<=this.indexOf(b)};String.prototype.format=function(){var b=arguments;return this.replace(/\{(\d+)\}/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})};String.prototype.times=function(b){for(var a="",c=0;c<b;c++)a+=this;return a};String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")});Utils=$=function(){return{Class:function(b){var a=b._init||function(){},c=b.extend;a.prototype=b;b._init=void 0;b.extend=void 0;c&&this.extend(a,c);c&&c.extended&&c.extended(a);return a},extend:function(b,a){for(var c in a.prototype)c in b.prototype||(b.prototype[c]=a.prototype[c])},type:function(b){return Object.prototype.toString.call(b)},copy:function(b){Array.prototype.slice.call(arguments,1).forEach(function(a){for(var c in a)b[c]=a[c]});return b},clone:function(b){return this.copy({},b)},delay:function(b,a){return setTimeout(a,1E3*b)}}}();Device=function(){return{cancelVibration:function(){navigator.vibrate&&navigator.vibrate(0)},vibrate:function(b){navigator.vibrate&&(this.cancelVibration(),navigator.vibrate(b||20))},quitApp:function(){Env.isCocoonJS?Env.callAPI("forceToFinish"):window.close()},is:function(b){b=RegExp(b,"i");return b.test(navigator.userAgent)||b.test(navigator.appVersion)}}}();Env=function(){var b={PHONEGAP:{is:void 0!==window.PhoneGap,name:"PhoneGap"},DIRECT_CANVAS:{is:void 0!==window.AppMobi,name:"DirectCanvas"},COCOON_JS:{is:void 0!==navigator.isCocoonJS,name:"CocoonJS",methods:{callAPI:function(){var a=window.ext.IDTK_APP;a.makeCall.apply(a,arguments)}}},DEV:{name:"Dev"}},a={},c,d;for(d in b){var f=b[d],e=a[d]={};f.is&&(c=e);if(f.methods)for(var g in f.methods)a[d][g]=f.methods[g]}c||(b.DEV.is=!0,c=a.DEV);for(var h in b){var e=a[h],k;for(k in b)e[k]=a[k],e["is"+b[k].name]=b[k].is}return c}();Event=function(){function b(a,b,c,g){if(g){var h=b;b=c;c=g;g=h}b.split(" ").forEach(function(b){(g?g:document)[a](b,c,!1)})}function a(a,c,e){b("addEventListener",a,c,e)}function c(b,c){a(document,"keyup",function(a){a.keyCode===c&&b()})}return{bind:a,unbind:function(a,c,e){b("removeEventListener",a,c,e)},backPressed:function(b){switch(Env){case Env.DEV:c(b,27);break;case Env.COCOON_JS:window.onidtkappfinish=b;break;case Env.PHONEGAP:a(document,"backbutton",b);break;case Env.DIRECT_CANVAS:a(document,"appMobi.device.hardware.back",b)}},menuPressed:function(b){switch(Env){case Env.DEV:c(b,32);break;case Env.PHONEGAP:a(document,"menubutton",b)}},devicePaused:function(b){switch(Env){case Env.COCOON_JS:Env.callAPI("App","onsuspended");break;case Env.PHONEGAP:a(document,"pause",b);break;case Env.DIRECT_CANVAS:a(document,"appMobi.device.pause",b)}},deviceResumed:function(b){switch(Env){case Env.COCOON_JS:Env.callAPI("App","onactivated");break;case Env.PHONEGAP:a(document,"resume",b);break;case Env.DIRECT_CANVAS:a(document,"appMobi.device.resume",b)}},deviceReady:function(b){switch(Env){case Env.PHONEGAP:a(document,"deviceready",b);break;case Env.DIRECT_CANVAS:a(document,"appMobi.device.ready",b)}},pageLoaded:function(b){a(document,"DOMContentLoaded",b)},allFired:function(a){var b=a.events.length,c=function(){0===--b&&a.callback()};a.events.forEach(function(a){a(c)})}}}();JSON=JSON||{};JSON.load=function(b,a){var c=new XMLHttpRequest;c.onreadystatechange=function(){4!==c.readyState||0!==c.status&&200!==c.status||a(JSON.parse(c.responseText))};c.open("GET",b+".json",!0);c.send(null)};AbstractLoader=function(){return $.Class({_init:function(){this.loaded=this.loaded.bind(this);this.reset();0<arguments.length&&this.load.apply(this,arguments)},load:function(){throw"Must override abstract method 'load'!";},reset:function(){this._loadedListeners=[];this._progressListeners=[];this._loaded=!1},loaded:function(b){this._loaded?b():this._loadedListeners.add(b)},progress:function(b){this._progressListeners.add(b)},_notifyLoadedListeners:function(){this._loaded=!0;this._loadedListeners.forEach(function(b){b()})},_notifyProgressListeners:function(b){this._progressListeners.forEach(function(a){a(b)})},_traverseAndLoad:function(b,a,c,d,f,e){for(var g in b){var h=b[g];if(Array.isArray(h)){var k,l=c;"_"===g?k=a:(l+=g+"/",k=a[g]=a[g]||{});f(h);h.forEach(function(a){this._loadResource(k,l,a,d,e)}.bind(this))}else a[g]=a[g]||{},this._traverseAndLoad(b[g],a[g],c+g+"/",d,f,e)}},_loadResource:function(){throw"Must override abstract method '_loadResource'!";},_loadResources:function(b,a,c){function d(a){f+=a.length}var f=0,e=0,g=function(){this._notifyProgressListeners(e/f);++e>=f&&this._notifyLoadedListeners()}.bind(this),h;for(h in b)this._traverseAndLoad(b[h],c,a,h,d,g)}})}();ImageLoader=function(){var b=function(){return!1},a=$.Class({extend:AbstractLoader,_init:function(){AbstractLoader.apply(this,arguments)},load:function(a,d){this._loadResources(d,a+"/"+(b()?"x":"h")+"dpi/",Image)},_loadResource:function(a,b,f,e,g){var h=new Image;h.onload=g;h.src=b+f+"."+e;a[f]=h}});a.isXDPI=function(a){b=a};return a}();AudioLoader=function(){var b={"audio/ogg":"ogg","audio/mpeg":"mp3"},a,c=new Audio,d;for(d in b)if(c.canPlayType(d)){a=b[d];break}return $.Class({extend:AbstractLoader,_init:function(){AbstractLoader.apply(this,arguments)},load:function(b,c){if(!a)throw"No supported audio types!";var d={};d[a]=c;this._loadResources(d,b+"/"+a+"/",Audio)},_loadResource:function(a,b,c,d,k){b=b+c+"."+d;d=new Audio;d.oncanplaythrough=k;d.src=b;a[c]=d}})}();DPI={X:{width:1280,height:720},H:{width:800,height:480},M:{width:480,height:320},S:{width:320,height:200}};PersistedObject=$.Class({_init:function(b,a){a=a||{};var c=localStorage.getItem(b);this.data=c?JSON.parse(c):a;this._name=b;this._defVals=a;this.persist()},persist:function(){localStorage.setItem(this._name,JSON.stringify(this.data))},clear:function(){this.data=this._defVals;this.persist()}});Random=function(){function b(a){a=a.toString();for(var b=0;b<a.length;b++){d+=a.charCodeAt(b);var c=0.02519603282416938*d;d=c>>>0;c-=d;c*=d;d=c>>>0;c-=d;d+=4294967296*c}return 2.3283064365386963E-10*(d>>>0)}function a(){var a=2091639*f+2.3283064365386963E-10*k;f=e;e=g;return g=a-(k=a|0)}function c(b,c){return b+(a()+1.1102230246251565E-16*(2097152*a()|0))*(c-b)}var d=4022871197,f,e,g,h=Date.now(),k=1;f=e=g=b(" ");f-=b(h);e-=b(h);g-=b(h);0>f&&(f+=1);0>e&&(e+=1);0>g&&(g+=1);c.intgr=function(b,c){c||(c=b,b=0);return Math.floor(b+(a()+1.1102230246251565E-16*(2097152*a()|0))*(c-b+1))};c.bool=function(){return 0.5>a()+1.1102230246251565E-16*(2097152*a()|0)};return c}();Line=$.Class({_init:function(b,a,c,d){c==b?(this.m=0,this.c=b,this.isParallelToY=!0):(this.m=(d-a)/(c-b),this.c=a-b*this.m,this.isParallelToY=!1)},_calcPointFromQuadEqParams:function(b,a,c){var d=this.m,f=this.c;b=(d*(a-f)+b+c)/(Math.pow(d,2)+1);return new Point(b,d*b+f)},intersectCircle:function(b,a,c){if(this.isParallelToY)return[new Point(b,a-c),new Point(b,a+c)];var d=this.m,f=this.c;c=Math.pow(d*(f-a)-b,2)-(Math.pow(d,2)+1)*(Math.pow(b,2)-Math.pow(c,2)+(f-a)*(f-a));if(0===c)return[this._calcPointFromQuadEqParams(b,a,0)];if(0<c)return c=Math.sqrt(c),[this._calcPointFromQuadEqParams(b,a,c),this._calcPointFromQuadEqParams(b,a,-c)]},intersect:function(b){if(this.isParallelToY)return new Point(this.c,b.m*this.c+b.c);if(b.isParallelToY)return new Point(b.c,this.m*b.c+this.c);var a=this.m,c=b.m,d=this.c;b=b.c;var f=a-c;return new Point((b-d)/f,(b*a-d*c)/f)}});Point=$.Class({_init:function(b,a){this.x=b;this.y=a},distance:function(b){return Math.sqrt(Math.pow(this.x-b.x,2)+Math.pow(this.y-b.y,2))}});ForceDirected=function(){return $.Class({_init:function(b){b.bvFactor=800/b.maxDim;$.copy(this,b)},runOnce:function(){var b=this.operations,a=this.bvFactor,c=this.antiGravityReach,d=this.antiGravity,f=this.nodePadding,e=this.gravity;this.circles.forEach(function(g){this.circles.forEach(function(h){if(!b.equals(g,h)){var k=b.getX(g)*a,l=b.getY(g)*a,m=b.getX(h)*a,n=b.getY(h)*a,p=b.radius(g)*a,r=b.radius(h)*a,s=k-m,q=l-n,w=Math.pow(s,2)+Math.pow(q,2),v=Math.sqrt(w),s=s/v,q=q/v;if(b.ownsEdgeTo(g,h)){var t=v-p-r-f*Math.max(p,r);if(0<t){var u=Math.log(Math.pow(t,e)/(b.owningEdges(g)+b.owningEdges(h))),t=u*s,u=u*q;b.setX(g,(k-=t)/a);b.setY(g,(l-=u)/a);b.setX(h,(m+t)/a);b.setY(h,(n+u)/a)}}h=800*d*b.value(g)*b.value(h)/w;p=(p+r)*c-v;0<p&&(h*=Math.log(p));b.setX(g,(k+h*s)/a);b.setY(g,(l+h*q)/a)}}.bind(this));b.keepInBounds(g)}.bind(this))}})}();DAO=function(){function b(b,d){if(void 0===d)return a.data.muted[b];a.data.muted[b]=d;a.persist()}var a=new PersistedObject("state",{scores:{},muted:{sound:!1,music:!1}});return{loadLevel:function(b,d,f){LevelData.get(b,d,function(e){a.data.turns=e.solution;a.data.level=e;a.data.level.d=b;a.data.level.l=d;a.persist();f()})},clearDb:function(){a.clear()},isFreshDb:function(){return void 0===a.data.level},isIntroNeeded:function(){return this.isFreshDb()},saveGameLayout:function(b){a.data.level.layout=LevelData.makeLayout(b);a.persist()},isGameOver:function(){return a.data.level.layout.isEmpty()},getGameLayout:function(){return LevelData.parseLayout(a.data.level.layout)},getScore:function(b,d){var f=a.data.level;return a.data.scores[LevelData.toCode(b?b:f.d,d?d:f.l)]},getSolution:function(){return a.data.level.solution},getLevel:function(){return a.data.level.l},getDifficulty:function(){return a.data.level.d},getNextLevel:function(){var a=this.getDifficulty(),b=this.getLevel();do++b>Level.MAX&&(++a>Difficulty.HARD&&(a=Difficulty.EASY),b=1);while(LevelData.isLocked(a,b));return{difficulty:a,level:b}},getTurns:function(){return a.data.turns},decreaseTurns:function(b){a.data.turns-=void 0===b?1:b;a.persist()},evalScore:function(){var b=a.data.level;return Math.max(0,Math.min(1,(a.data.turns+b.solution)/b.solution))},saveScore:function(){var b=a.data.level;a.data.scores[LevelData.toCode(b.d,b.l)]=this.evalScore();a.persist()},soundMuted:function(a){return b("sound",a)},musicMuted:function(a){return b("music",a)}}}();LevelData=function(){var b=0,a=0,c=Config.resources.levels.meta.locked;return{setLevelDimensions:function(c,f){b=c;a=f},makeLayout:function(c){var f=[];c.forEach(function(c){var d={};d[0]=c.getId();d[1]=c.isActive()?1:0;d[2]=c.getScore();d[3]={};d[3][0]=100*(c.getX()/b);d[3][1]=100*(c.getY()/a);d[4]=[];c.getOwnNeighbours().forEach(function(a){d[4].add(a.getId())});f.add(d)});return f},parseLayout:function(c){var f=[];c.forEach(function(c){f.add({id:c[0],x:c[3][0]/100*b,y:c[3][1]/100*a,active:1===c[1],score:c[2],connections:c[4]})});return f},get:function(a,b,c){JSON.load(Config.resources.levels.pathFormat.format(a,b),c)},isLocked:function(a,b){return 1===c[a-1][b-1]},toCode:function(a,b){return 100*parseInt(a,10)+parseInt(b,10)}}}();Level={MAX:6,isLocked:function(b,a){return LevelData.isLocked(b,a)},each:function(b){for(var a=1;a<=this.MAX;a++)b(a)}};Difficulty={EASY:1,NORMAL:2,HARD:3,each:function(b){for(var a in this)"each"!==a&&b(this[a],a)}};SoundManager=function(){function b(a,c){for(var d in a){var e=a[d];void 0!==e.volume?e.volume=c?0:1:b(e,c)}}function a(a){e[a].play();Event.bind(e[a],"ended",c)}function c(){Event.unbind(e[g],"ended",c);d()}function d(){++g===e.length&&(g=0);$.delay(f,function(){a(g)})}var f=3,e=[],g;return{muteSound:function(a){b(Audio.sound,a)},muteMusic:function(a){b(Audio.music,a)},startMusic:function(b){for(var c in Audio.music)e.add(Audio.music[c]);b=b.shuffle;e.isEmpty()||a(g=b?Random.intgr(0,e.length-1):0)},play:function(a){var b=new Audio(a.src);b.volume=a.volume;b.play()}}}();Kinetic.ProportionalImage=function(){var b=$.Class({_init:function(a){Kinetic.Image.call(this,a);this.on("widthChange",this._syncHeight);this.on("heightChange",this._syncWidth);void 0!==a.width?this.setWidth(a.width):void 0!==a.height&&this.setHeight(a.height)},_syncDim:function(a,b,d){var f=this.getImage();this.attrs[b]=f[b]*d.newVal/f[a]},_syncWidth:function(a){this._syncDim("height","width",a)},_syncHeight:function(a){this._syncDim("width","height",a)},refreshWidth:function(){this._syncWidth({newVal:this.getHeight()})},refreshHeight:function(){this._syncHeight({newVal:this.getWidth()})}});Kinetic.Util.extend(b,Kinetic.Image);return b}();Kinetic.TextGroup=function(){var b=$.Class({_init:function(a){a.listening=!1;Kinetic.Group.call(this,a)},addText:function(a,b){this.add(new Kinetic.ProportionalImage({width:a.width,image:a,opacity:void 0===b?0:b}));this._calcSize(a);this._calcPosition()},_calcSize:function(a){this._maxText=!this._maxText||a.width>this._maxText.width?a:this._maxText;this.each(function(a){a.setWidth(a.getImage().width/this._maxText.width*this.getWidth())}.bind(this))},_calcPosition:function(){var a=0;this.each(function(b){a+=b.getHeight()});var b=(this.getHeight()-a)/(this.size()-1),d=0;this.each(function(a){a.setY(d);d+=a.getHeight()+b;this.centerHorizontally(a)}.bind(this))}});Kinetic.Util.extend(b,Kinetic.Group);return b}();Kinetic.PressCatcher=function(){var b=$.Class({_init:function(a){a.image=Image.bg.trans;Kinetic.Rect.call(this,a);this.on("tap click",a.onPress)}});Kinetic.Util.extend(b,Kinetic.Rect);return b}();Kinetic.ProgressBar=function(){var b=$.Class({_init:function(a){Kinetic.Group.call(this,a);this._build();this.on("percentChange",this._percentChanged)},_build:function(){for(var a=this.getWidth(),b=this.getHeight(),a=(a-15*b)/14,d=0;15>d;d++)this.add(new Kinetic.ProportionalImage({x:d*(b+a),height:b,image:Image.text.dot,opacity:0}))},_percentChanged:function(a){a.cancelBubble=!0;var b=this.getWidth(),d=0.3*b,f=this.getReversed(),e=Math.abs(a.newVal-(f?1:0))*(b+d)-d;this.each(function(a){var b=a.getX()+a.getWidth()/2;f?a.setOpacity(e>b?0:Math.min(b-e,d)/d):a.setOpacity(1-(e>b?0:Math.min(b-e,d)/d))});this.getLayer().draw()}});Kinetic.Util.extend(b,Kinetic.Group);Kinetic.Node.addGetterSetter(b,"percent",0);Kinetic.Node.addGetterSetter(b,"reversed",!1);return b}();Kinetic.AbstractButton=function(){return $.Class({_init:function(){this.on("click tap",this._onPressAbstract)},_onPressAbstract:function(b){b.cancelBubble=!0;this._delayListening();this._playPressSound()},_delayListening:function(){this.setListening(!1);$.delay(0.5,function(){this.setListening(!0);this.getLayer().draw()}.bind(this))},_playPressSound:function(){SoundManager.play(Audio.sound.tap.button)},_vibrateDevice:function(){Device.vibrate()}})}();Kinetic.SimpleButton=function(){var b=$.Class({_init:function(a){Kinetic.Image.call(this,a);Kinetic.AbstractButton.call(this,a);this.on("click tap",this._onPress)},_onPress:function(){this.attrs.onPress.call(this)}});Kinetic.Util.extend(b,Kinetic.Image);Kinetic.Util.extend(b,Kinetic.AbstractButton);return b}();Kinetic.ToggleButton=function(){var b=$.Class({_init:function(a){a.image=a.images.enabled;a.onPress=this._toggle;Kinetic.SimpleButton.call(this,a);this.on("enabledChange",this.refresh)},_toggle:function(){var a=!this.getEnabled();this.setEnabled(a);if(a)this.attrs.onEnable();else this.attrs.onDisable()},refresh:function(){var a=this.getEnabled();this.setImage(this.attrs.images[a?"enabled":"disabled"]);this.getLayer().draw()}});Kinetic.Util.extend(b,Kinetic.SimpleButton);Kinetic.Node.addGetterSetter(b,"enabled",!0);return b}();Kinetic.ProgressCircle=function(){var b=$.Class({_init:function(a){Kinetic.Group.call(this,a);Kinetic.AbstractButton.call(this,a);a=Image.button.progress[this.getSize()];this.add(this.base=this._createImage(a.base));this.add(this.hand=this._createImage(a.hand,!0));this.add(this.complete=this._createImage(a.complete));this.add(this.empty=this._createImage(a.empty));this.add(this.overlay=this._createOverlay());this.on("percentChange",this._percentChanged);this._delegatePress()},clear:function(){this.destroyTween();this.setPercent(0);this.empty.show()},nullify:function(){this.destroyTween();this.setPercent(0);this.empty.hide();this._showTicker();return this},_showTicker:function(){this.complete.hide();this.base.show();this.overlay.show();this.hand.show()},_delegatePress:function(){var a=this._onPressChild.bind(this);this.each(function(b){b.on("click tap",a)})},_onPressChild:function(a){a.cancelBubble=!0;this.fire("tap");this.attrs.onPress.call(this)},_percentChanged:function(a){a=a.newVal;1===a?this.complete.isVisible()||(this.complete.show(),this.base.hide(),this.overlay.hide(),this.hand.hide()):this.complete.isVisible()&&this._showTicker();this.hand.setRotation(2*Math.PI*a);1<=a?this.overlay.isVisible()&&this.overlay.hide():(this.overlay.isVisible()||this.overlay.show(),this.overlay.setAngle(2*Math.PI*(0>=a?1:a)))},_createOverlay:function(){var a=this.getRadius();return new Kinetic.Wedge({x:a,y:a,radius:a,fill:"black",opacity:0.3,rotation:0.5*-Math.PI,clockwise:!0,angle:0})},_createImage:function(a,b){var d=this.getRadius(),f=b?d:0;return new Kinetic.Image({x:f,y:f,width:2*d,height:2*d,image:a,offset:{x:f,y:f}})}});Kinetic.Util.extend(b,Kinetic.Group);Kinetic.Util.extend(b,Kinetic.AbstractButton);Kinetic.Node.addGetterSetter(b,"percent",0);Kinetic.Node.addGetterSetter(b,"size","small");Kinetic.Node.addGetterSetter(b,"radius");return b}();Kinetic.Connection=function(){var b=$.Class({_init:function(a){a.drawFunc=this.drawFunc;Kinetic.Shape.call(this,a);this.getCircles().forEach(function(a){a.on("xChange yChange radiusChange",this.refresh.bind(this))}.bind(this));this.drawn=!0;this.refresh();this.markerImg=Image.circle.connection.marker},refresh:function(){if(this.drawn){this.drawn=!1;this._markers=[];var a=this.getCircles(),b=a[0],d=a[1],a=b.getX(),f=b.getY(),e=b.getRadius(),g=d.getX(),h=d.getY(),k=d.getRadius(),l=Math.max(4,2),d=this.attrs.markerRadius,b=2*d,m=new Line(a,f,g,h),a=m.intersectCircle(a,f,e-b),n=m.intersectCircle(g,h,k-b),p=Number.MAX_VALUE,r,s;a.forEach(function(a){n.forEach(function(b){var c=a.distance(b);c<p&&(p=c,r=a,s=b)})});a=r.x;f=r.y;g=s.x;h=s.y;m=p/b;e=Math.floor(m);e-=e%2;if(!(2>e)){var q=0,k=0;if(e<l)q=m%2/2;else if(e=l,k=(m-e)/(e+1),1.5<=k){for(q=1.5+(k-1.5)*(e+1)/2;2.5<q;)e+=2,q-=2.5;k=1.5}else q=k;l=0.5+q;q=0;g=(g-a)/m;for(h=(h-f)/m;q<e;q++)m=q*(1+k)+l,this._markers.add([a+m*g-d,f+m*h-d,b])}}},drawFunc:function(a){var b=a.getContext(),d=this.markerImg;this._markers.forEach(function(a){b.drawImage(d,a[0],a[1],a[2],a[2])});this.drawn=!0},getCircles:function(){return this.attrs.circles},hasCircle:function(a){var b=this.getCircles();return b[0]===a||b[1]===a}});Kinetic.Util.extend(b,Kinetic.Shape);return b}();Kinetic.GameCircle=function(){var b=$.Class({_init:function(a){Kinetic.Image.call(this,a);this.attrs.connections=[];this.attrs._connections=[];this.attrs.neighbours=[];this.attrs.ownNeighbours=[];this._ownsConnection={};this.on("click tap",this._pressed);this.on("radiusChange",this._syncRadiusWithImageSize);this.on("widthChange heightChange",this._syncSizeWithOffset);this.setRadius(this._calcRadius());this._updateImage()},_updateImage:function(){var a=this.getScore();this.setImage(this.attrs.active?Image.circle.active[a]:Image.circle.passive[a])},_syncRadiusWithImageSize:function(){var a=2*this.getRadius();this.setSize(a,a)},_calcRadius:function(a){return this.attrs.radiusFunc(this.getScore()+(a||0),5)},_syncSizeWithOffset:function(){this.setOffset(this.getWidth()/2,this.getHeight()/2)},getConnections:function(){return this.attrs.connections},_removeConnection:function(a){this.attrs.connections.remove(a)},getNeighbours:function(){return this.attrs.neighbours},_removeNeighbour:function(a){this.attrs.neighbours.remove(a)},getOwnNeighbours:function(){return this.attrs.ownNeighbours},_addOwnNeighbour:function(a){this.attrs.ownNeighbours.add(a);this._ownsConnection[a._id]=!0},_removeOwnNeighbour:function(a){this.attrs.ownNeighbours.remove(a);this._ownsConnection[a._id]=!1},connections:function(){return this.getConnections().length},connect:function(a){if(a!=this&&!this.isConnected(a)){var b=new Kinetic.Connection($.copy({circles:[this,a]},this.attrs.connection));this.getConnections().add(b);a.getConnections().add(b);this.getNeighbours().add(a);a.getNeighbours().add(this);this._addOwnNeighbour(a);this.attrs.connection.parent.add(b)}},disconnect:function(a){if(a!=this&&this.isConnected(a)){var b;this.getConnections().forEach(function(d){d.hasCircle(a)&&(b=d)});this._removeConnection(b);a._removeConnection(b);this._removeNeighbour(a);a._removeNeighbour(this);this.ownsConnectionWith(a)?this._removeOwnNeighbour(a):a._removeOwnNeighbour(this);b.destroy()}},ownsConnectionWith:function(a){return this._ownsConnection[a._id]},isConnected:function(a){return this.getNeighbours().contains(a)},toggleActive:function(){this.attrs.active=!this.isActive();this._updateImage()},isActive:function(){return this.attrs.active},setScore:function(a){this.attrs.score=a},getScore:function(){return this.attrs.score},getPressCountLeft:function(){return 2*this.getScore()+(this.isActive()?-1:0)},decreaseScore:function(){this.setScore(this.getScore()-1)},_playPressSound:function(){SoundManager.play(Audio.sound.tap.circle)},_animatePress:function(){var a=this.isTweening(),b=this.isActive(),d=this._calcRadius(),f=this.getRadius(),e=a?b?this._calcRadius(1):d:f,g=a||b?d:f;this.to({radius:1.2*e,duration:0.2,easing:"StrongEaseOut",callback:function(){this.to({radius:0.95*g,duration:0.5,easing:"BackEaseInOut",callback:function(){this.to({radius:g,duration:0.15,easing:"BackEaseOut"})}})}})},removeCircle:function(){this._removeCircle()},_removeCircle:function(a){var b=this.getNeighbours().clone();b.forEach(function(a){a.setListening(!1)});this.setListening(!1);this.to({scaleX:0,scaleY:0,opacity:0.1,rotation:2*Math.PI,duration:1<this.getScore()?0.6:0.3,callback:function(){var d=this.getParent();b.forEach(function(a){this.disconnect(a);a.setListening(!0)}.bind(this));this.destroy();d.fire((a?"pressed":"disconnected")+"Removed",{circle:this,neighbours:b})}});this.getConnections().forEach(function(a){a.to({opacity:0,duration:0.3})})},_pressed:function(a){a.cancelBubble=!0;this._playPressSound();this.isActive()?1===this.getScore()?this._removeCircle(!0):(this.decreaseScore(),this._animatePress(),this.toggleActive(),0<this.connections()&&this.getParent().fire("activePressed",this)):(this._animatePress(),this.toggleActive());this.getParent().fire("onePressed",this)},simulatePress:function(){this._pressed({})}});Kinetic.Util.extend(b,Kinetic.Image);Kinetic.Node.addGetterSetter(b,"radius");Kinetic.Node.addGetterSetter(b,"score");return b}();Kinetic.Counter=function(){var b=$.Class({_init:function(a){Kinetic.Group.call(this,a);this.on("heightChange",this._syncDimensions);this.on("valueChange",this._valueChanged);this._origOpacity=this.getOpacity();this._initCounter();this._syncDimensions()},_addDigitImage:function(){var a=new Kinetic.ProportionalImage({listening:!1});a.on("heightChange",function(a){a.cancelBubble=!0});this.add(a);return a},_toDigitArr:function(a){a=Math.abs(a)+"";a=a.length>this.getSize()?"9".times(this.getSize()):a;return a.split("")},_calcWidth:function(a,b,d){var f=this.getPadding();return a*b*(1+f+(d?-f:0))},_syncDimensions:function(){var a=this.getHeight(),b;this.getChildren().forEach(function(d,f){d.setHeight(a);d.setX(this._calcWidth(f,b=d.getWidth()));d.setY(0)}.bind(this));void 0!==b&&(this.setWidth(this._calcWidth(this.size(),b,!0)),this.setSizeWidth(this._calcWidth(this.getSize(),b,!0)))},_animateValueChange:function(){this.to({duration:0.5,easing:"StrongEaseOut",opacity:1,scaleX:1.2,scaleY:1.2,callback:function(){this.to({duration:0.5,easing:"StrongEaseIn",opacity:this._origOpacity,scaleX:1,scaleY:1})}})},_removeUnusedImages:function(a){for(;this.size()>a.length;)this.getChildren().last().remove()},_getSignLabel:function(a){return 0>a?"neg":"pos"},_initCounter:function(){var a=this.getValue();this._updateCounter(this._toDigitArr(a),this._getSignLabel(a))},_updateCounter:function(a,b){var d=this.getChildren();a.forEach(function(a,e){var g=d[e];g||(g=this._addDigitImage());g.setImage(Image.digit[b][a])}.bind(this))},_valueChanged:function(a){a.cancelBubble=!0;var b=parseInt(a.newVal,10);a=parseInt(a.oldVal,10);b!==a&&(a=this._toDigitArr(b),this._removeUnusedImages(a),this._updateCounter(a,this._getSignLabel(b)),this._syncDimensions(),this.isAnimate()&&this.isVisible()&&0<this.getAbsoluteOpacity()?this._animateValueChange():this.getLayer().draw(),this.isTicking()&&this._playChangeSound())},_playChangeSound:function(){SoundManager.play(Audio.sound.tick)},isAnimate:function(){return this.getAnimate()},isTicking:function(){return this.getTicking()}});Kinetic.Util.extend(b,Kinetic.Group);Kinetic.Node.addGetterSetter(b,"value",0);Kinetic.Node.addGetterSetter(b,"padding",0);Kinetic.Node.addGetterSetter(b,"animate",!0);Kinetic.Node.addGetterSetter(b,"ticking",!1);Kinetic.Node.addGetterSetter(b,"size",2);Kinetic.Node.addGetterSetter(b,"sizeWidth");return b}();Kinetic.CircledCounter=function(){var b=$.Class({_init:function(a){Kinetic.Group.call(this,a);this._build();this.on("valueChange",this._valueChanged)},_build:function(){var a=2*this.getRadius();this.add(this.circle=new Kinetic.Image({width:a,height:a,image:Image.icon.empty}));this.add(this.counter=new Kinetic.Counter({y:0.325*a,height:0.35*a,animate:!1}))},_valueChanged:function(a){this.counter.setValue(a.newVal);this.counter.setX(this.getRadius()-this.counter.getWidth()/2)},tickingOn:function(){this.counter.setTicking(!0)}});Kinetic.Util.extend(b,Kinetic.Group);Kinetic.Node.addGetterSetter(b,"value");Kinetic.Node.addGetterSetter(b,"radius");return b}();Kinetic.DoubleCounter=function(){var b=$.Class({_init:function(a){Kinetic.Group.call(this,a);this._digit=Image.digit.big;this._build();this.on("valueOneChange",this._valueOneChanged);this.on("valueTwoChange",this._valueTwoChanged);this._updateHorLocation()},_build:function(){var a=this.getHeight();this.add(this.counter1=new Kinetic.ProportionalImage({height:a,image:this._digit[0]}));this.add(this.separator=new Kinetic.ProportionalImage({y:a*(1-0.7)/2,height:0.7*a,size:1,image:Image.digit.separator}));this.add(this.counter2=new Kinetic.ProportionalImage({height:a,image:this._digit[0]}))},_updateHorLocation:function(){var a=this.getPadding();this.separator.setX(this.counter1.getWidth()+a);this.counter2.setX(this.separator.getX()+this.separator.getWidth()+a)},_valueOneChanged:function(a){this.counter1.setImage(this._digit[a.newVal]);this.counter1.refreshWidth();this._updateHorLocation()},_valueTwoChanged:function(a){this.counter2.setImage(this._digit[a.newVal]);this.counter2.refreshWidth()}});Kinetic.Util.extend(b,Kinetic.Group);Kinetic.Node.addGetterSetter(b,"valueOne");Kinetic.Node.addGetterSetter(b,"valueTwo");Kinetic.Node.addGetterSetter(b,"padding");return b}();Kinetic.Easings.SoftBackEaseOut=function(b,a,c,d,f,e){return c*((b=b/d-1)*b*(2*b+1)+1)+a};Kinetic.Easings.SoftBackEaseIn=function(b,a,c,d,f,e){return c*(b/=d)*b*(2*b-1)+a};Kinetic.Easings.SoftBackEaseInOut=function(b,a,c,d,f,e){f=1;return 1>(b/=d/2)?c/2*b*b*(((f*=1.525)+1)*b-f)+a:c/2*((b-=2)*b*(((f*=1.525)+1)*b+f)+2)+a};Kinetic.StepAnimation=function(){var b=$.Class({_init:function(a){this.onStep(a.onStep);this.onComplete(a.onComplete);Kinetic.Animation.call(this,this._animFunc.bind(this),a.redrawNode)},_animFunc:function(){this.currentStep++;this._onStep();this.currentStep==this.finalStep&&(this.stop(),this._onComplete())},onStep:function(a){this._onStep=a},onComplete:function(a){this._onComplete=a},run:function(a){this.currentStep=0;this.finalStep=a;this.start()}});Kinetic.Util.extend(b,Kinetic.Animation);return b}();Kinetic.LayoutManager=function(){var b=$.Class({_init:function(a){a.onStep=this._onAdjustStep;Kinetic.StepAnimation.call(this,a);this._circles=a.circles;this._conns=a.connections;this._corners=a.clearCorners;this._bounds=a.bounds;this._initAlgorithm()},_onAdjustStep:function(){this._algorithm.runOnce();this._conns.forEach(function(a){a.refresh()});this._circles.forEach(function(a){a.cachedTransform=void 0})},_clearFromCorners:function(a,b,d,f,e,g){for(var h in this._corners){var k=this._corners[h],l=0,m=0,n=!1;switch(h){case "tl":l=f+k.width;m=f+k.height;n=b<l&&d<m;break;case "tr":l=e-k.width;m=f+k.height;n=b>l&&d<m;break;case "bl":l=f+k.width;m=g-k.height;n=b<l&&d>m;break;case "br":l=e-k.width,m=g-k.height,n=b>l&&d>m}n&&(Math.abs(b-l)<Math.abs(d-m)?a.attrs.x=l:a.attrs.y=m)}},_keepInBounds:function(a){var b=a.attrs.radius,d=a.attrs.x,f=a.attrs.y,e=this._bounds.padding,g=b+e,h=this._bounds.width-b-e,b=this._bounds.height-b-e;d<g?a.attrs.x=g:d>h&&(a.attrs.x=h);f<g?a.attrs.y=g:f>b&&(a.attrs.y=b);this._clearFromCorners(a,d,f,g,h,b)},_initAlgorithm:function(){this._algorithm=new ForceDirected({circles:this._circles,operations:{equals:function(a,b){return a===b},radius:function(a){return a.attrs.radius},value:function(a){return a.attrs.score},getX:function(a){return a.attrs.x},getY:function(a){return a.attrs.y},setX:function(a,b){a.attrs.x=b},setY:function(a,b){a.attrs.y=b},ownsEdgeTo:function(a,b){return a.ownsConnectionWith(b)},owningEdges:function(a){return a.connections()},keepInBounds:this._keepInBounds.bind(this)},maxDim:this._bounds.width,antiGravity:4,antiGravityReach:4,gravity:2,nodePadding:0.2})},adjustLayout:function(){this.run(15)}});Kinetic.Util.extend(b,Kinetic.StepAnimation);return b}();Kinetic.Loading=function(){var b=$.Class({_init:function(a){a.listening=!1;Kinetic.Group.call(this,a);this._build();this.on("percentChange",this._percentChanged)},_build:function(){var a=this.getWidth(),b=this.getHeight(),d=this.attrs.unit;this.add(this.bg=new Kinetic.Rect({width:a,height:b,fill:"black"}));this.add(this.text=new Kinetic.ProportionalImage({height:6*d,image:Image.text.loading}));this.add(this.bar=new Kinetic.ProgressBar({y:0.8*b,width:0.7*a,height:2.2*d,reversed:!0}));this.center(this.text);this.centerHorizontally(this.bar)},_percentChanged:function(a){this.text.setOpacity(1-a.newVal);this.bar.setPercent(1-a.newVal);this.getParent().draw()},destroy:function(){Kinetic.Group.prototype.destroy.call(this);delete Image.text.loading}});Kinetic.Util.extend(b,Kinetic.Group);Kinetic.Node.addGetterSetter(b,"percent");return b}();Kinetic.AbstractSlidingContainer=function(){var b=$.Class({_init:function(a){Kinetic.Group.call(this,a);a=this.getWidth();this.add(this.rightSide=new Kinetic.Group({x:a,visible:!1}));this.add(this.leftSide=new Kinetic.Group({x:-a,visible:!1}));this._buildBGs()},_buildBGs:function(){var a=this.getWidth(),b=this.getHeight();this.leftSide.add(new Kinetic.Image({width:a,height:b,image:Image.menu.side.left,opacity:0.75}));this.rightSide.add(new Kinetic.Image({width:a,height:b,image:Image.menu.side.right,opacity:0.75}))},_showSide:function(a){a.side.show();a.side.to({duration:a.duration,easing:"BackEaseOut",x:this.getWidth()*a.extend,callback:a.callback})},_hideLeftSide:function(a,b){this._hideSide({side:this.leftSide,direction:-1,duration:a,callback:b})},_hideRightSide:function(a,b){this._hideSide({side:this.rightSide,direction:1,duration:a,callback:b})},_hideSide:function(a){a.side.to({duration:a.duration,easing:"BackEaseIn",x:a.direction*this.getWidth(),callback:function(){a.side.hide();a.callback&&a.callback()}})}});Kinetic.Util.extend(b,Kinetic.Group);return b}();Kinetic.GameOver=function(){var b=$.Class({_init:function(a){Kinetic.AbstractSlidingContainer.call(this,a);this._build()},_build:function(){var a=this.getWidth(),b=this.getHeight();this._createBlinkingText("highScore");this._createBlinkingText("worseScore");this._createBlinkingText("sameScore");this._createBlinkingText("completed");this._createBlinkingText("skipped");this.add(this.pressCatcher=new Kinetic.PressCatcher({width:a,height:b,visible:!1,onPress:this._skipAnimation.bind(this)}))},_createBlinkingText:function(a){this.add(this[a]=new Kinetic.ProportionalImage({name:"blinkingText",height:6*this.attrs.unit,image:Image.text[a],opacity:0,visible:!1}));this.center(this[a])},_rebuildRightSide:function(){var a=2*this.attrs.padding,b=this.attrs.unit,d=this.getWidth(),f=this.getHeight();this.rightSide.scoreText&&this.rightSide.scoreText.destroy();this.rightSide.add(this.rightSide.scoreText=new Kinetic.ProportionalImage({x:0.2*d,y:a,height:0.4*f,image:Image.text.score}));this.rightSide.turns&&this.rightSide.turns.destroy();this.rightSide.add(this.rightSide.turns=new Kinetic.CircledCounter({x:0.3*d,y:a,radius:6*b}));this.rightSide.score&&this.rightSide.score.destroy();this.rightSide.add(this.rightSide.score=new Kinetic.ProgressCircle({x:0.23*d,y:f-18*b-a,radius:9*b,size:"large",listening:!1}))},_traverseGroups:function(a,b){b(a);"Group"===a.nodeType&&a.getChildren().clone().forEach(function(a){this._traverseGroups(a,b)}.bind(this))},_blinkText:function(a,b){this[a].show();this[a].to({duration:b?b:0.5,opacity:1,callback:function(){this[a].to({duration:b?b:0.5,opacity:0,callback:function(){this[a].hide()}.bind(this)})}.bind(this)})},_hasEnded:function(){return!this.pressCatcher.isVisible()},_skipAnimation:function(){this._traverseGroups(this,function(a){switch(a.getName()){case "blinkingText":a.hide();break;case "scoreSign":a.destroy();break;default:a.destroyTween()}});this._scoreIsMoving&&(this.rightSide.score.hide(),this._scoreIsMoving=!1);this._blinkText("skipped");this._hideAll(function(){this.fire("animationSkipped")}.bind(this))},animateCountingScore:function(a){this._rebuildRightSide();var b=a.turns,d=a.score;this.rightSide.turns.setValue(a.solution);this.rightSide.score.nullify();this._showSide({side:this.rightSide,extend:0.44,duration:0.7,callback:function(){this.pressCatcher.show();this._countToZero(b,d,a.callback)}.bind(this)})},_countToZero:function(a,b,d){this.rightSide.turns.tickingOn();this.rightSide.turns.to({value:Math.max(a,0),duration:4,easing:"EaseOut"});this.rightSide.score.to({percent:Math.max(b,0.999),duration:5,easing:"SoftBackEaseOut",callback:function(){this._countToTurns(a,b,d)}.bind(this)})},_countToTurns:function(a,b,d){0>a?(this.rightSide.turns.to({value:a,duration:4,easing:"EaseOut"}),this.rightSide.score.to({percent:b,duration:6,easing:"SoftBackEaseOut",callback:d})):(this._blinkText("completed",0.7),d())},animateMergingScore:function(a){var b=this.rightSide.score,d=a.mergeWith,f=d.getRadius()/b.getRadius(),e=b.toLocalOf(d);this._scoreIsMoving=!0;b.to({x:e.x,y:e.y,scaleX:f,scaleY:f,opacity:0.5,duration:4,easing:"EaseInOut",callback:function(){$.delay(0.7,function(){this._hasEnded()||this._animateScoreComparison(b,d,a.callback)}.bind(this))}.bind(this)})},_animateScoreComparison:function(a,b,d){var f=a.getPercent(),e=b.getPercent();void 0===e||f>e?this._animateNewHighScore(a,b,d):f<e?this._animateWorseScore(a,d):this._animateNewHighScore(a,b,d)},_animateNewHighScore:function(a,b,d){this._blinkText("highScore",0.7);this._showScoreChangeSign("plus",a,function(){b.to({percent:a.getPercent(),duration:2,easing:"SoftBackEaseOut",callback:function(){a.hide();this._hideAll(d)}.bind(this)})}.bind(this))},_animateWorseScore:function(a,b){this._blinkText("worseScore",0.7);this._showScoreChangeSign("minus",a,function(){a.to({opacity:0,duration:1,callback:function(){this._hideAll(b)}.bind(this)})}.bind(this))},_animateSameScore:function(a,b){this._blinkText("sameScore",0.7);this._showScoreChangeSign("equal",a,function(){a.hide();this._hideAll(b)}.bind(this))},_showScoreChangeSign:function(a,b,d){a=this._addSameSizedImage(b,Image.icon[a]);a.to({opacity:0,duration:1,easing:"EaseIn",callback:function(){a.destroy();d()}})},_addSameSizedImage:function(a,b){var d=new Kinetic.Image({name:"scoreSign",x:a.getX(),y:a.getY(),width:2*a.getRadius(),height:2*a.getRadius(),scaleX:a.getScaleX(),scaleY:a.getScaleY(),image:b});a.getParent().add(d);return d},_hideAll:function(a){this._hasEnded()||(this._scoreIsMoving=!1,this.pressCatcher.hide(),this._hideRightSide(0.7,a))}});Kinetic.Util.extend(b,Kinetic.AbstractSlidingContainer);return b}();Kinetic.Menu=function(){var b=$.Class({_init:function(a){Kinetic.AbstractSlidingContainer.call(this,a);this._buildLeftSide();this._buildRightSide()},_difficultySelected:function(a,b){b=b||{replacementScore:[]};void 0!==a&&(this._selectedDifficulty=a);this._fullyExtendLeftSide(b.callback);this.leftSide.level.buttons.each(function(a){var f=a.getName();if(Level.isLocked(this._selectedDifficulty,f))a.lockedIcon.show(),a.hide();else{a.lockedIcon.hide();a.show();var e=this._score(this._selectedDifficulty,f),f=b.replacementScore[f];void 0===e?a.clear():(e=void 0!==f?f:e,a.nullify().setPercent(0.5*e),a.to({percent:e,duration:Random(0.8,1.2),easing:"SoftBackEaseOut",callback:function(){$.delay(0.1,function(){this.getLayer().draw()}.bind(this))}}))}}.bind(this))},_levelSelected:function(a){this.fire("levelSelected",{difficulty:this._selectedDifficulty,level:a})},_toggleRightSidePressed:function(){this.leftSide.isVisible()?this.leftSide.difficulty.isVisible()?void 0===this._selectedDifficulty?this._hideLeftSide():this._difficultySelected():this._showLeftSide():this._showLeftSide()},_buildNormalLeftSide:function(a,b,d,f,e,g){var h=this;this.leftSide.add(this.leftSide.difficulty=new Kinetic.Group);this.leftSide.difficulty.add(this.leftSide.difficulty.buttons=new Kinetic.Group);this.leftSide.difficulty.add(this.leftSide.difficulty.text=new Kinetic.ProportionalImage({x:0.9*a,y:2*f,height:0.5*b,image:Image.text.difficulty}));Difficulty.each(function(b,c){this.leftSide.difficulty.buttons.add(new Kinetic.SimpleButton({name:b,x:a*e,y:f*b+g*(b-1),width:g,height:g,image:Image.button.difficulty[c.toLowerCase()],onPress:function(){h._difficultySelected(this.getName())}}))}.bind(this))},_buildExtendedLeftSide:function(a,b,d,f,e,g){var h=this,k=g/2;this.leftSide.add(this.leftSide.level=new Kinetic.Group);this.leftSide.level.add(this.leftSide.level.buttons=new Kinetic.Group);this.leftSide.level.add(this.leftSide.level.icons=new Kinetic.Group);this.leftSide.level.add(this.leftSide.level.text=new Kinetic.ProportionalImage({x:0.9*a,y:2*f,height:0.4*b,image:Image.text.level}));Level.each(function(b){var c=b%2,d=Math.ceil(b/2),c=a*e-(g+f)*c,d=f*d+g*(d-1);this.leftSide.level.buttons.add(b=new Kinetic.ProgressCircle({name:b,x:c,y:d,radius:k,onPress:function(){h._levelSelected(this.getName())}}));this.leftSide.level.icons.add(b.lockedIcon=new Kinetic.ProportionalImage({x:c,y:d,width:g,image:Image.icon.locked}))}.bind(this))},_buildLeftSide:function(){var a=this.attrs.unit,b=this.attrs.padding,d=this.getWidth(),f=this.getHeight(),e=9*a;this._buildNormalLeftSide(d,f,a,b,0.73,e);this._buildExtendedLeftSide(d,f,a,b,0.73,e)},_buildRightSide:function(){var a=this.attrs.unit,b=this.attrs.padding,d=this.getWidth(),f=this.getHeight(),e=6*a,g=8*a;this.rightSide.add(this.rightSide.resume=new Kinetic.SimpleButton({x:0.35*d-e-b,y:b,width:e,height:e,image:Image.button.resume,onPress:function(){this.fire("resumed")}.bind(this)}));this.rightSide.add(this.rightSide.next=new Kinetic.SimpleButton({x:0.35*d-g-b,y:b,width:g,height:g,image:Image.button.next,visible:!1,onPress:function(){this.fire("nextLevel")}.bind(this)}));this.rightSide.add(this.rightSide.showRightSide=new Kinetic.SimpleButton({x:d*(0.35-0.15),y:0.5*f-g,width:g,height:g,image:Image.button.difficulty.choose,onPress:this._toggleRightSidePressed.bind(this)}));this.rightSide.add(this.rightSide.restart=new Kinetic.SimpleButton({x:d*(0.35-0.185),y:0.5*f+2*a,width:g,height:g,image:Image.button.restart,onPress:function(){this.fire("restart")}.bind(this)}));this.rightSide.add(this.rightSide.music=new Kinetic.ToggleButton({x:0.35*d-e-b,y:f-e-b,width:e,height:e,images:{enabled:Image.button.music.on,disabled:Image.button.music.off},onEnable:function(){this.fire("musicMuted",{muted:!1})}.bind(this),onDisable:function(){this.fire("musicMuted",{muted:!0})}.bind(this)}));this.rightSide.add(this.rightSide.sound=new Kinetic.ToggleButton({x:0.35*d-2*e-3*b,y:f-e-b,width:e,height:e,images:{enabled:Image.button.sound.on,disabled:Image.button.sound.off},onEnable:function(){this.fire("soundMuted",{muted:!1})}.bind(this),onDisable:function(){this.fire("soundMuted",{muted:!0})}.bind(this)}))},_showLeftSide:function(a){this._showSide({side:this.leftSide,extend:-0.7,duration:0.6,callback:a});this.leftSide.level.hide();this.leftSide.difficulty.show()},_fullyExtendLeftSide:function(a){this._showSide({side:this.leftSide,extend:-0.55,duration:0.6,callback:a});this.leftSide.level.show();this.leftSide.difficulty.hide()},_hideLeftSide:function(){Kinetic.AbstractSlidingContainer.prototype._hideLeftSide.call(this,0.6)},_hideRightSide:function(){Kinetic.AbstractSlidingContainer.prototype._hideRightSide.call(this,0.6)},afterSideAnimated:function(a){$.delay(0.6,a.bind(this))},getLevelCircle:function(a){return this.leftSide.level.buttons.get("."+a).first()},showLevelSelector:function(a){this._difficultySelected(a.difficulty,a)},tapResume:function(){var a=this.rightSide.resume;a.isVisible()&&a.isListening()&&a.fire("tap")},hideMenu:function(a){this._hideLeftSide();this._hideRightSide();var b=this.isListening();this.setListening(!1);this.afterSideAnimated(function(){b&&this.setListening(!0);a&&(a(),this.getLayer().draw())})},showMenu:function(a){a?(a.showNext&&(this.rightSide.resume.hide(),this.rightSide.next.show()),a.rightSide&&this._toggleRightSidePressed()):(this.rightSide.resume.show(),this.rightSide.next.hide());this._showSide({side:this.rightSide,extend:0.65,duration:0.6})},soundMuted:function(a){this.rightSide.sound.setEnabled(!a)},musicMuted:function(a){this.rightSide.music.setEnabled(!a)},scoreCallback:function(a){this._score=a}});Kinetic.Util.extend(b,Kinetic.AbstractSlidingContainer);return b}();Kinetic.Quit=function(){var b=$.Class({_init:function(a){a.visible=!1;Kinetic.Group.call(this,a);this._build();this.on("visibleChange",function(){this.getLayer().draw()})},_build:function(){var a=2*this.attrs.padding,b=this.getWidth(),d=this.getHeight(),f=0.5*d;this.add(this.bg=new Kinetic.Rect({width:b,height:d,fill:"black",opacity:0.4}));this.add(this.message=new Kinetic.ProportionalImage({y:a,height:0.3*d,image:Image.text.quit}));this.message.setX((b-this.message.getWidth())/2);this.add(this.no=new Kinetic.SimpleButton({x:a,y:d-a-f,width:f,height:f,image:Image.button.quit.no,onPress:function(){this.hide()}.bind(this)}));this.add(this.yes=new Kinetic.SimpleButton({x:b-a-f,y:d-a-f,width:f,height:f,image:Image.button.quit.yes,onPress:function(){this.fire("quit")}.bind(this)}))}});Kinetic.Util.extend(b,Kinetic.Group);return b}();Kinetic.Fading=function(){var b=$.Class({_init:function(a){a.fill="black";a.listening=!1;Kinetic.Rect.call(this,a)},fadeOut:function(a,b){this.to({opacity:0,easing:"EaseIn",duration:a,callback:function(){this.destroy();b&&b()}})},longFadeOut:function(a){this.fadeOut(5,a)},fastFadeOut:function(a){this.fadeOut(1,a)}});Kinetic.Util.extend(b,Kinetic.Rect);return b}();Kinetic.Background=function(){var b=$.Class({_init:function(a){a.listening=!1;Kinetic.Group.call(this,a);this.add(this.normal=this._createImage(Image.bg.normal));this.add(this.gs=this._createImage(Image.bg.gs))},_createImage:function(a){return new Kinetic.Image({width:this.getWidth(),height:this.getHeight(),image:a})},toGrayscale:function(a){this.gs.show();this.gs.to({duration:0.5,opacity:1,callback:a})},toColor:function(a){this.gs.to({duration:0.5,opacity:0,callback:function(){this.gs.hide();a&&a()}.bind(this)})}});Kinetic.Util.extend(b,Kinetic.Group);return b}();Kinetic.Game=function(){var b=$.Class({_init:function(a){Kinetic.Group.call(this,a);this.add(this.connections=new Kinetic.Group({listening:!1}));this.add(this.circles=new Kinetic.Group({listening:!1}));this.add(this.hud=this._createHUD());this.add(this.pressCatcher=this._createPressCatcher())},_createHUD:function(){return new Kinetic.HUD({width:this.getWidth(),height:this.getHeight(),unit:this.attrs.unit,padding:this.attrs.padding,listening:!1,opacity:0})},_createPressCatcher:function(){return new Kinetic.PressCatcher({width:this.getWidth(),height:this.getHeight(),onPress:this._skipFadeIn.bind(this),visible:!1})},_setGroupOpacity:function(a,b){a.each(function(a){a.setOpacity(b)})},_fadeInObject:function(a,b){a.to({opacity:1,duration:0.5,easing:"EaseOut",callback:b})},_fadeOutObject:function(a,b){a.to({opacity:0,duration:0.5,easing:"EaseIn",callback:b})},_spreadingFadeIn:function(a,b,d,f){a.forEach(function(a){d.triggered[a._id]||1===a.getOpacity()||(d.triggered[a._id]=!0,this._fadeInObject(a),$.delay(0.5,function(){this._spreadingFadeIn(a.getNeighbours(),a.getConnections(),d,f)}.bind(this)))}.bind(this));$.delay(0.25,function(){b.forEach(function(a){d.triggered[a._id]||1===a.getOpacity()||(d.triggered[a._id]=!0,this._fadeInObject(a,function(){0===--d.left&&f()}))}.bind(this))}.bind(this))},_afterSpreadingFinished:function(){this.pressCatcher.hide();this.hud.fadeIn(this.fadeInCallback)},_prepareFadeIn:function(){this.pressCatcher.show();this.setListening(!1);this.hud.setOpacity(0);this.connections.setOpacity(1);this.circles.setOpacity(1);this._setGroupOpacity(this.circles,0);this._setGroupOpacity(this.connections,0)},_skipFadeIn:function(){[this.circles,this.connections].forEach(function(a){a.each(function(a){a.finishTween();a.setOpacity(1)})});this._afterSpreadingFinished.call(this)},fadeIn:function(a){this.fadeInCallback=a;this._prepareFadeIn();a=this.circles.getChildren();a=a[Random.intgr(0,a.length-1)];var b={left:this.connections.size(),triggered:{}};this._spreadingFadeIn([a],[],b,this._afterSpreadingFinished.bind(this))},fadeOut:function(a){this.setListening(!1);this._fadeOutObject(this.hud,function(){this._fadeOutObject(this.connections,function(){this._fadeOutObject(this.circles,a)}.bind(this))}.bind(this))},initCircles:function(a){this._clear();var b=this.getWidth()*this.getHeight(),d=Math.floor(Math.sqrt(0.04*b/Math.PI))-1,f=function(a,b){return d*Math.sqrt(a/b)};a.forEach(function(a){a=new Kinetic.GameCircle({id:a.id,x:a.x,y:a.y,active:a.active,score:a.score,radiusFunc:f,connection:{parent:this.connections,markerRadius:0.1*d}});this.circles.add(a)}.bind(this));this._connectCircles(a)},setListening:function(a){this.connections.setListening(a);this.circles.setListening(a);this.hud.setListening(a)},_clear:function(){this.circles.removeChildren();this.connections.removeChildren()},_connectCircles:function(a){a.forEach(function(a){var b=this.circles.get("#"+a.id).first();a.connections.forEach(function(a){a=this.circles.get("#"+a).first();b.connect(a)}.bind(this))}.bind(this))}});Kinetic.Util.extend(b,Kinetic.Group);return b}();Kinetic.Intro=function(){var b=$.Class({_init:function(a){Kinetic.Group.call(this,a);this._build()},_build:function(){var a=this.getWidth(),b=this.getHeight();this.add(this.darkOverlay=new Kinetic.Rect({width:a,height:b,fill:"black",opacity:0}));this.add(this.objects=new Kinetic.Group({width:a,height:b,listening:!1,opacity:0}));this.add(this.texts=new Kinetic.Group({width:a,height:b,listening:!1}));this.add(this.pressCatcher=new Kinetic.PressCatcher({width:a,height:b,onPress:this._skip.bind(this)}));this._createCenteredText({name:"title",size:23,opacity:1});this._createCenteredText({name:"goodLuck",size:7});this._createCenteredText({name:"quickHints",size:6});this._createTextGroup({name:"scoreHint",w:0.75,h:0.22,x:0.125,y:0.24});this._createTextGroup({name:"aCircleHint",w:0.8,h:0.2,x:0.1,y:0.5});this._createTextGroup({name:"pCircleHint",w:0.8,h:0.33,x:0.1,y:0.2});this._createTextGroup({name:"circleHint",w:0.7,h:0.6,center:!0})},addObject:function(a){this.objects.add(a)},_destroyObjects:function(){for(;!this.objects.children.isEmpty();)this.objects.children[0].destroy()},_skip:function(){this.introCallback&&this._finishAnimatingIntro(!0);this.hintsCallback&&this._destroyAndExit(!0)},_createCenteredText:function(a){this.texts.add(this.texts[a.name]=new Kinetic.ProportionalImage({name:a.name,height:this.attrs.unit*a.size,image:Image.text.intro[a.name],opacity:a.opacity?a.opacity:0}));this.texts.center(this.texts[a.name])},_createTextGroup:function(a){var b=this.getWidth(),d=this.getHeight();this.texts.add(this.texts[a.name]=new Kinetic.TextGroup({width:b*a.w,height:d*a.h}));for(var f=1,e;e=Image.text.intro[a.name+f];f++)this.texts[a.name].addText(e);a.center?this.texts.center(this.texts[a.name]):this.texts[a.name].setPosition(a.x*b,a.y*d)},_fadeIn:function(a,b){a.to({duration:1.8,opacity:1,callback:b})},_fadeOut:function(a,b){a.to({duration:1.8,opacity:0,callback:b})},_fadeInOut:function(a,b){this._fadeIn(a,function(){this._fadeOut(a,b.bind(this))}.bind(this))},_fadeInOutGroupNodes:function(a,b){var d=a.getChildren(),f=Math.ceil(a.size()/2),e=0,g=0,h=function(){e!==a.size()&&(e===f&&k(),this._fadeIn(d[e++],h))}.bind(this),k=function(){g===a.size()?b.call(this):this._fadeOut(d[g++],k)}.bind(this);h()},_animateHint:function(a){this.fire(a.hintEvt);this.getLayer().draw();$.delay(0.5,function(){this._fadeIn(this.objects,function(){var b;b=a.skipDestroy?a.callback.bind(this):function(){this._fadeOut(this.objects,function(){this._destroyObjects();a.callback.call(this)}.bind(this))}.bind(this);this._fadeInOutGroupNodes(this.texts[a.group],b)}.bind(this))}.bind(this))},_beforeAnimateHints:function(a){this.darkOverlay.to({duration:1.5,opacity:0.65,callback:function(){this._fadeInOut(this.texts.quickHints,a.bind(this))}.bind(this)})},_afterAnimateHints:function(a){this.darkOverlay.to({duration:1.5,opacity:0,callback:function(){this._destroyObjects();this._fadeInOut(this.texts.goodLuck,a)}.bind(this)})},_execExternalCallback:function(a,b,d){b?(d.draw(),$.delay(0.3,a)):a()},_finishAnimatingIntro:function(a){this.texts.title.destroy();var b=this.introCallback,d=this.getLayer();delete this.introCallback;this._execExternalCallback(b,a,d)},_destroyAndExit:function(a){var b=this.getLayer();this.destroy();this._execExternalCallback(this.hintsCallback,a,b)},animateHints:function(a){this.hintsCallback=a;this._beforeAnimateHints(function(){this._animateHint({hintEvt:"hintScore",group:"scoreHint",callback:function(){this._animateHint({hintEvt:"hintActiveCircle",group:"aCircleHint",callback:function(){this._animateHint({hintEvt:"hintPassiveCircle",group:"pCircleHint",callback:function(){this._animateHint({hintEvt:"hintCircle",group:"circleHint",skipDestroy:!0,callback:function(){this._afterAnimateHints(this._destroyAndExit)}})}})}})}})})},animateIntro:function(a){this.introCallback=a;this.texts.title.to({duration:5,opacity:0,callback:this._finishAnimatingIntro.bind(this)})},destroy:function(){Kinetic.Group.prototype.destroy.call(this);delete Image.text.intro}});Kinetic.Util.extend(b,Kinetic.Group);return b}();Kinetic.Message=function(){var b=$.Class({_init:function(a){a.listening=!1;Kinetic.Group.call(this,a)},_prepareText:function(a,b){this.getWidth();this.getHeight();this.add(this.text=new Kinetic.ProportionalImage({height:5.5*this.attrs.unit,opacity:b,image:this._getTextImage(a)}));this.center(this.text)},_getTextImage:function(a){for(var b=0,d=Image.text;b<a.length;b++)d=d[a[b]];return d},setToFadeOut:function(){this._prepareText(arguments,0.8)},fadeIn:function(){this._prepareText(arguments,0);this.text.to({duration:1.5,opacity:0.8})},delayedFadeIn:function(){var a=arguments;$.delay(0.3,function(){this.fadeIn.apply(this,a)}.bind(this))},fadeOut:function(a){this.text&&this.text.to({duration:0.8,opacity:0,callback:function(){this.text.destroy();delete this.text;a&&a()}.bind(this)})}});Kinetic.Util.extend(b,Kinetic.Group);return b}();Kinetic.HUD=function(){var b=$.Class({_init:function(a){Kinetic.Group.call(this,a);this._build();this.on("turnsValChange",this._onTurnsAnim)},_build:function(){var a=this.attrs.padding,b=this.attrs.unit,d=this.getWidth(),f=6*b;this.add(this.turns=new Kinetic.Counter({listening:!1,x:a,y:a,height:5*b,opacity:0.6}));this.add(this.pause=new Kinetic.SimpleButton({x:d-a-f,y:a,width:f,height:f,opacity:0.6,image:Image.button.pause,onPress:function(){this.fire("paused")}.bind(this)}));this.add(this.limit=new Kinetic.ProportionalImage({x:this.turns.getSizeWidth()+2*a,width:0.65*d,listening:!1,image:Image.text.limit,opacity:0}));this.limit.setY(-this.limit.getHeight())},tapPause:function(){var a=this.pause;a.isVisible()&&a.isListening()&&a.fire("tap")},setTurns:function(a){a.animate?this.to({duration:1,turnsVal:a.value,callback:a.callback}):(this.setTurnsVal(a.value),a.callback&&a.callback())},_onTurnsAnim:function(a){this.turns.setValue(a.newVal);0<=a.oldVal&&0>a.newVal&&this._animateNegativeBorderCrossing()},_animateNegativeBorderCrossing:function(){var a=this.limit.getY();this.limit.to({duration:1,easing:"BackEaseOut",y:this.attrs.padding,opacity:0.6,callback:function(){$.delay(1,function(){this.to({duration:1,easing:"BackEaseIn",opacity:0,callback:function(){this.setY(a)}})}.bind(this))}})},floatNumber:function(a){a=new Kinetic.Counter({x:a.position.x,y:a.position.y,height:4*this.attrs.unit,opacity:0.6,value:(a.negative?-1:1)*a.number,animate:!1,listening:!1});a.setOffset(a.getWidth()/2,a.getHeight()/2);this.add(a);a.to({duration:0.5,easing:"StrongEaseOut",scaleX:1.5,scaleY:1.5,callback:function(){this.to({duration:0.5,easing:"EaseIn",opacity:0,scaleX:0.5,scaleY:0.5,callback:function(){this.destroy()}})}})},fadeIn:function(a){this.to({opacity:1,duration:1,easing:"EaseOut",callback:a})}});Kinetic.Util.extend(b,Kinetic.Group);Kinetic.Node.addGetterSetter(b,"turnsVal");return b}();Kinetic.InactiveDisplay=function(){var b=$.Class({_init:function(a){a.visible=!1;a.opacity=0;Kinetic.Group.call(this,a);this._build()},_build:function(){var a=this.attrs.padding,b=this.attrs.unit,d=this.getHeight(),b=15*b;this.add(this.level=new Kinetic.DoubleCounter({listening:!1,x:3*a,y:d-2*a-b,height:b,padding:2*a}))},setLevel:function(a,b){this.level.setValueOne(a);this.level.setValueTwo(b)},fadeIn:function(a){this.show();this.to({opacity:0.5,duration:0.6,easing:"EaseOut",callback:a})},fadeOut:function(a){this.to({opacity:0,duration:0.6,easing:"EaseIn",callback:function(){this.hide();a&&a()}.bind(this)})}});Kinetic.Util.extend(b,Kinetic.Group);return b}();Kinetic.GameOver=function(){var b=$.Class({_init:function(a){Kinetic.AbstractSlidingContainer.call(this,a);this._build()},_build:function(){var a=this.getWidth(),b=this.getHeight();this._createBlinkingText("highScore");this._createBlinkingText("worseScore");this._createBlinkingText("sameScore");this._createBlinkingText("completed");this._createBlinkingText("skipped");this.add(this.pressCatcher=new Kinetic.PressCatcher({width:a,height:b,visible:!1,onPress:this._skipAnimation.bind(this)}))},_createBlinkingText:function(a){this.add(this[a]=new Kinetic.ProportionalImage({name:"blinkingText",height:6*this.attrs.unit,image:Image.text[a],opacity:0,visible:!1}));this.center(this[a])},_rebuildRightSide:function(){var a=2*this.attrs.padding,b=this.attrs.unit,d=this.getWidth(),f=this.getHeight();this.rightSide.scoreText&&this.rightSide.scoreText.destroy();this.rightSide.add(this.rightSide.scoreText=new Kinetic.ProportionalImage({x:0.2*d,y:a,height:0.4*f,image:Image.text.score}));this.rightSide.turns&&this.rightSide.turns.destroy();this.rightSide.add(this.rightSide.turns=new Kinetic.CircledCounter({x:0.3*d,y:a,radius:6*b}));this.rightSide.score&&this.rightSide.score.destroy();this.rightSide.add(this.rightSide.score=new Kinetic.ProgressCircle({x:0.23*d,y:f-18*b-a,radius:9*b,size:"large",listening:!1}))},_traverseGroups:function(a,b){b(a);"Group"===a.nodeType&&a.getChildren().clone().forEach(function(a){this._traverseGroups(a,b)}.bind(this))},_blinkText:function(a,b){this[a].show();this[a].to({duration:b?b:0.5,opacity:1,callback:function(){this[a].to({duration:b?b:0.5,opacity:0,callback:function(){this[a].hide()}.bind(this)})}.bind(this)})},_hasEnded:function(){return!this.pressCatcher.isVisible()},_skipAnimation:function(){this._traverseGroups(this,function(a){switch(a.getName()){case "blinkingText":a.hide();break;case "scoreSign":a.destroy();break;default:a.destroyTween()}});this._scoreIsMoving&&(this.rightSide.score.hide(),this._scoreIsMoving=!1);this._blinkText("skipped");this._hideAll(function(){this.fire("animationSkipped")}.bind(this))},animateCountingScore:function(a){this._rebuildRightSide();var b=a.turns,d=a.score;this.rightSide.turns.setValue(a.solution);this.rightSide.score.nullify();this._showSide({side:this.rightSide,extend:0.44,duration:0.7,callback:function(){this.pressCatcher.show();this._countToZero(b,d,a.callback)}.bind(this)})},_countToZero:function(a,b,d){this.rightSide.turns.tickingOn();this.rightSide.turns.to({value:Math.max(a,0),duration:4,easing:"EaseOut"});this.rightSide.score.to({percent:Math.max(b,0.999),duration:5,easing:"SoftBackEaseOut",callback:function(){this._countToTurns(a,b,d)}.bind(this)})},_countToTurns:function(a,b,d){0>a?(this.rightSide.turns.to({value:a,duration:4,easing:"EaseOut"}),this.rightSide.score.to({percent:b,duration:6,easing:"SoftBackEaseOut",callback:d})):(this._blinkText("completed",0.7),d())},animateMergingScore:function(a){var b=this.rightSide.score,d=a.mergeWith,f=d.getRadius()/b.getRadius(),e=b.toLocalOf(d);this._scoreIsMoving=!0;b.to({x:e.x,y:e.y,scaleX:f,scaleY:f,opacity:0.5,duration:4,easing:"EaseInOut",callback:function(){$.delay(0.7,function(){this._hasEnded()||this._animateScoreComparison(b,d,a.callback)}.bind(this))}.bind(this)})},_animateScoreComparison:function(a,b,d){var f=a.getPercent(),e=b.getPercent();void 0===e||f>e?this._animateNewHighScore(a,b,d):f<e?this._animateWorseScore(a,d):this._animateNewHighScore(a,b,d)},_animateNewHighScore:function(a,b,d){this._blinkText("highScore",0.7);this._showScoreChangeSign("plus",a,function(){b.to({percent:a.getPercent(),duration:2,easing:"SoftBackEaseOut",callback:function(){a.hide();this._hideAll(d)}.bind(this)})}.bind(this))},_animateWorseScore:function(a,b){this._blinkText("worseScore",0.7);this._showScoreChangeSign("minus",a,function(){a.to({opacity:0,duration:1,callback:function(){this._hideAll(b)}.bind(this)})}.bind(this))},_animateSameScore:function(a,b){this._blinkText("sameScore",0.7);this._showScoreChangeSign("equal",a,function(){a.hide();this._hideAll(b)}.bind(this))},_showScoreChangeSign:function(a,b,d){a=this._addSameSizedImage(b,Image.icon[a]);a.to({opacity:0,duration:1,easing:"EaseIn",callback:function(){a.destroy();d()}})},_addSameSizedImage:function(a,b){var d=new Kinetic.Image({name:"scoreSign",x:a.getX(),y:a.getY(),width:2*a.getRadius(),height:2*a.getRadius(),scaleX:a.getScaleX(),scaleY:a.getScaleY(),image:b});a.getParent().add(d);return d},_hideAll:function(a){this._hasEnded()||(this._scoreIsMoving=!1,this.pressCatcher.hide(),this._hideRightSide(0.7,a))}});Kinetic.Util.extend(b,Kinetic.AbstractSlidingContainer);return b}();UI=function(){function b(){m=window.innerWidth;n=window.innerHeight;Env.isDev&&(m=Dev.WIDTH,n=Dev.HEIGHT);LevelData.setLevelDimensions(m,n)}function a(){h=new Kinetic.Stage({container:document.body,width:m,height:n});h.add(k=new Kinetic.Layer)}function c(){g={width:h.getWidth(),height:h.getHeight(),padding:Math.ceil(h.getWidth()*f)};g.unit=g.padding*e/Math.max(g.width/g.height,e)}function d(){var a=p.game.hud.turns,b=p.game.hud.pause;r.layoutManager=new Kinetic.LayoutManager({circles:p.game.circles.getChildren(),connections:p.game.connections.getChildren(),clearCorners:{tl:{width:a.getSizeWidth(),height:a.getHeight()},tr:{width:b.getWidth(),height:b.getHeight()}},redrawNode:k,bounds:$.clone(g)})}var f=0.016,e=15/9,g,h,k,l,m,n,p={},r={build:function(){h?(k.getChildren().forEach(function(a){a.destroy()}),l=null):(b(),a(),c());k.add(p.bg=new Kinetic.Background($.clone(g)));k.add(p.game=new Kinetic.Game($.clone(g)));k.add(p.inactiveDisp=new Kinetic.InactiveDisplay($.clone(g)));k.add(p.menu=new Kinetic.Menu($.clone(g)));k.add(p.gameOver=new Kinetic.GameOver($.clone(g)));DAO.isIntroNeeded()&&k.add(p.intro=new Kinetic.Intro($.clone(g)));k.add(p.message=new Kinetic.Message($.clone(g)));k.add(p.quit=new Kinetic.Quit($.clone(g)));k.add(p.fading=new Kinetic.Fading($.clone(g)));$.copy(r,p);d()},showLoading:function(){h||(b(),a(),c(),k.add(l=new Kinetic.Loading($.clone(g))).draw())},trackLoading:function(a){l&&l.setPercent(a)}};return r}();Controller=function(){var b={},a=$.Class({_init:function(a){b[a]=this},ctrInit:function(){},ctr:function(a){return b[a]}});a.extended=function(a){a=new a;b[a.ctrName]=a};a.initAll=function(){for(var a in b)b[a].ctrInit()};return a}();InitController=$.Class({extend:Controller,ctrName:"init",ctrInit:function(){this.initUI();this.initSound();this.initMenuState();this.launch()},initUI:function(){UI.build()},initSound:function(){SoundManager.muteSound(DAO.soundMuted());SoundManager.muteMusic(DAO.musicMuted());SoundManager.startMusic({shuffle:!DAO.isFreshDb()})},initMenuState:function(){UI.menu.soundMuted(DAO.soundMuted());UI.menu.musicMuted(DAO.musicMuted());UI.menu.scoreCallback(function(b,a){return DAO.getScore(b,a)})},launch:function(){DAO.isFreshDb()?this.ctr("game").firstGame():this.ctr("game").continueGame()}});IntroController=$.Class({extend:Controller,ctrName:"intro",ctrInit:function(){UI.intro&&(UI.intro.on("hintScore",this.hintScore.bind(this)),UI.intro.on("hintActiveCircle",this.hintActiveCircle.bind(this)),UI.intro.on("hintPassiveCircle",this.hintPassiveCircle.bind(this)),UI.intro.on("hintCircle",this.hintCircle.bind(this)))},hintScore:function(){var b=UI.game.hud.turns.clone();b.setOpacity(1);UI.intro.addObject(b)},hintActiveCircle:function(){UI.game.circles.each(function(b){b.isActive()&&UI.intro.addObject(b.clone())})},hintPassiveCircle:function(){UI.game.circles.each(function(b){b.isActive()||UI.intro.addObject(b.clone())})},hintCircle:function(){UI.intro.addObject(UI.game.circles.clone())}});GameController=$.Class({extend:Controller,ctrName:"game",ctrInit:function(){UI.game.circles.on("onePressed",this.circlePressed.bind(this));UI.game.circles.on("activePressed",this.activeCirclePressed.bind(this));UI.game.circles.on("disconnectedRemoved",this.disconnectedCircleRemoved.bind(this));UI.game.circles.on("pressedRemoved",this.pressedCircleRemoved.bind(this));UI.layoutManager.onComplete(this.layoutAdjusted.bind(this))},firstGame:function(){UI.fading.longFadeOut(function(){UI.intro.animateIntro(function(){this.newGame(1,1,this.showHints.bind(this),!0)}.bind(this))}.bind(this))},showHints:function(){UI.intro.animateHints(function(){delete UI.intro;this.activateGame()}.bind(this))},continueGame:function(){this.initGame();UI.message.setToFadeOut("continuing");UI.fading.fastFadeOut(function(){UI.message.fadeOut();DAO.isGameOver()?(UI.menu.showMenu({rightSide:!0,showNext:!0}),UI.inactiveDisp.fadeIn()):UI.game.hud.fadeIn(function(){this.activateGame()}.bind(this))}.bind(this))},newGame:function(b,a,c,d){d||UI.message.delayedFadeIn("levelName",b,a);DAO.loadLevel(b,a,function(){this.initGame();UI.game.fadeIn(function(){UI.message.fadeOut();c?c():this.activateGame()}.bind(this))}.bind(this))},initGame:function(){UI.game.hud.setTurns({value:DAO.getTurns()});UI.inactiveDisp.setLevel(DAO.getDifficulty(),DAO.getLevel());UI.game.initCircles(DAO.getGameLayout())},activateGame:function(){UI.bg.toColor(function(){UI.game.setListening(!0)})},saveLayout:function(){DAO.saveGameLayout(UI.game.circles.getChildren())},circlePressed:function(b){b.getNeighbours().forEach(function(a){a.toggleActive()});this.saveLayout();DAO.decreaseTurns();UI.game.hud.setTurns({value:DAO.getTurns()})},activeCirclePressed:function(){UI.layoutManager.adjustLayout()},pressedCircleRemoved:function(b){this.saveLayout();var a=!1;b.neighbours.forEach(function(b){0===b.connections()&&(b.removeCircle(),a=!0)});a&&this.saveLayout();UI.layoutManager.adjustLayout()},disconnectedCircleRemoved:function(b){var a=b.circle.getPressCountLeft();DAO.decreaseTurns(a);this.saveLayout();UI.game.hud.setTurns({value:DAO.getTurns(),animate:1<a,callback:function(){DAO.isGameOver()&&this.ctr("gameOver").gameOver()}.bind(this)});1<a&&UI.game.hud.floatNumber({position:b.circle.getPosition(),number:a,negative:!0})},layoutAdjusted:function(){this.saveLayout()}});GameOverController=$.Class({extend:Controller,ctrName:"gameOver",ctrInit:function(){UI.gameOver.on("animationSkipped",this.afterEnded.bind(this))},gameOver:function(){UI.game.setListening(!1);var b=DAO.getScore(),a=DAO.evalScore();(void 0===b||a>b)&&DAO.saveScore();$.delay(1,function(){UI.menu.hideMenu();UI.bg.toGrayscale(function(){UI.game.fadeOut(function(){this.animateGameOver(b,a)}.bind(this))}.bind(this))}.bind(this))},afterEnded:function(){UI.menu.hideMenu();UI.menu.afterSideAnimated(function(){UI.menu.setListening(!0);UI.menu.showMenu({rightSide:!0,showNext:!0})})},animateGameOver:function(b,a){UI.inactiveDisp.fadeIn();UI.gameOver.animateCountingScore({score:a,turns:DAO.getTurns(),solution:DAO.getSolution(),callback:function(){var a={};a[DAO.getLevel()]=void 0!==b?b:0;this.afterCountingScore(a)}.bind(this)})},afterCountingScore:function(b){$.delay(1,function(){UI.menu.setListening(!1);UI.menu.showLevelSelector({difficulty:DAO.getDifficulty(),replacementScore:b,callback:function(){UI.gameOver.animateMergingScore({mergeWith:UI.menu.getLevelCircle(DAO.getLevel()),callback:this.afterEnded})}.bind(this)})}.bind(this))}});ButtonController=$.Class({extend:Controller,ctrName:"button",ctrInit:function(){Event.backPressed(this.hardwareBackPressed);Event.menuPressed(this.hardwareMenuPressed);UI.quit.on("quit",this.quit.bind(this));UI.game.hud.on("paused",this.paused.bind(this));UI.menu.on("soundMuted",this.soundMuted.bind(this));UI.menu.on("musicMuted",this.musicMuted.bind(this));UI.menu.on("resumed",this.resumed.bind(this));UI.menu.on("restart",this.restart.bind(this));UI.menu.on("levelSelected",this.levelSelected.bind(this));UI.menu.on("nextLevel",this.nextLevel.bind(this))},hardwareBackPressed:function(){UI.quit.isVisible()?UI.quit.hide():UI.quit.show();return!1},hardwareMenuPressed:function(){UI.game.isListening()?UI.game.hud.tapPause():UI.menu.tapResume()},quit:function(){Device.quitApp()},paused:function(){UI.inactiveDisp.fadeIn();UI.menu.showMenu();UI.bg.toGrayscale();UI.game.setListening(!1)},resumed:function(){UI.inactiveDisp.fadeOut();UI.menu.hideMenu(function(){UI.game.setListening(!0)});UI.bg.toColor()},soundMuted:function(b){SoundManager.muteSound(b.muted);DAO.soundMuted(b.muted)},musicMuted:function(b){SoundManager.muteMusic(b.muted);DAO.musicMuted(b.muted)},prepareForNewGame:function(b){UI.inactiveDisp.fadeOut();UI.menu.hideMenu(function(){UI.game.fadeOut(b.bind(this))}.bind(this))},restart:function(){this.prepareForNewGame(function(){this.ctr("game").newGame(DAO.getDifficulty(),DAO.getLevel())})},levelSelected:function(b){this.prepareForNewGame(function(){this.ctr("game").newGame(b.difficulty,b.level)})},nextLevel:function(){this.prepareForNewGame(function(){var b=DAO.getNextLevel();this.ctr("game").newGame(b.difficulty,b.level)})}});(function(){Env.isDev&&Dev.FLUSH_DB&&DAO.clearDb();ImageLoader.isXDPI(function(){var a=window.innerWidth,b=window.innerHeight;Env.isDev&&(a=Dev.WIDTH,b=Dev.HEIGHT);return a>DPI.H.width&&b>DPI.H.height});DAO.isIntroNeeded()||delete Config.resources.images.files.common.png.text.intro;if(!Env.isDev){if(Device.is("android 2.3")||Device.is("ipad_1"))Config.resources.audio.files.music=[],DAO.musicMuted(!0);Device.is("ipad_1")&&ImageLoader.isXDPI(function(){return!1})}var b={splash:new ImageLoader(Config.resources.images.path,Config.resources.images.files.splash),image:new ImageLoader(Config.resources.images.path,Config.resources.images.files.common),audio:new AudioLoader(Config.resources.audio.path,Config.resources.audio.files)};b.image.progress(UI.trackLoading);Event.backPressed(function(){return!1});Event.allFired({events:[Event.pageLoaded,b.splash.loaded],callback:UI.showLoading});Event.allFired({events:[Event.pageLoaded,b.image.loaded,b.audio.loaded],callback:Controller.initAll});b=void 0})();</script>